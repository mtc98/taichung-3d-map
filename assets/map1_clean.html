<!DOCTYPE html>
<html>
<head>
    <title>å°ä¸­æ™¯é»</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
     <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #fff9e6;
            overflow: hidden; /* é¿å…æ»‘å‹•æ¢å‡ºç¾ */
        }

        #æ¨™é¡Œ {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;  /* æ”¹ç‚ºç™½è‰²èƒŒæ™¯ */
            color: #1976d2;  /* æ”¹ç‚ºè—è‰²æ–‡å­— */
            padding: 10px 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid #1976d2;  /* åŠ å…¥è—è‰²é‚Šæ¡† */
            display: flex;
            align-items: center;
            gap: 8px;  /* åœ–ç‰‡å’Œæ–‡å­—é–“çš„é–“è· */
        }

        #æ¨™é¡Œ img {
            height: 24px;  /* è¨­å®šGIFé«˜åº¦ */
            width: auto;
        }

        #åœ°åœ–å®¹å™¨ {
            height: 100vh;
            width: 100vw;
        }

        #å·¦å´é¢æ¿,
        #å³å´æ§åˆ¶ {
            position: fixed;
            top: 70px; /* ç¨å¾®å¾€ä¸‹ç§»å‹• */
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.4s ease, opacity 0.4s ease; /* åŠ å…¥å‹•ç•« */
        }

        #å·¦å´é¢æ¿ {
            left: 15px;
        }

        #å³å´æ§åˆ¶ {
            right: 15px;
            min-width: 200px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #222;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .æ™¯é»æŒ‰éˆ• {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #e3eaff;
            color: #222296;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .æ™¯é»æŒ‰éˆ•:hover {
            background: #b6c8ff;
        }

        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ• {
            background: #F7E7A1;
            color: #5a4a00;
        }
        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ•:hover {
            background: #E9D784;
        }

        /* é¢æ¿åˆ‡æ›æŒ‰éˆ• */
        .é¢æ¿åˆ‡æ›æŒ‰éˆ• {
            position: fixed;
            z-index: 25;
            background: rgba(34, 34, 150, 0.95);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .é¢æ¿åˆ‡æ›æŒ‰éˆ•:hover {
            background: rgb(49, 180, 224);
            transform: scale(1.1);
        }

        #leftPanelToggle {
            top: 70px;
            left: 15px;
        }

        #rightPanelToggle {
            top: 70px;
            right: 15px;
        }

        /* é¢æ¿éš±è—ç‹€æ…‹ */
        .é¢æ¿éš±è— {
            opacity: 0;
            pointer-events: none;
        }

        #å·¦å´é¢æ¿.é¢æ¿éš±è— {
            transform: translateX(-120%);
        }

        #å³å´æ§åˆ¶.é¢æ¿éš±è— {
            transform: translateX(120%);
        }

        /* å³ä¸Šè§’å›ºå®šè³‡è¨Šé¢æ¿ */
        #spot-info-panel {
            position: fixed;
            top: 70px;
            right: 15px;
            width: 350px;  /* å¢åŠ å¯¬åº¦ä»¥é©æ‡‰ç…§ç‰‡ */
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            padding: 20px;
            z-index: 30;
            font-family: Arial, sans-serif;
            border: 1px solid rgba(0,0,0,0.1);
            max-height: 500px; /* è¨­å®šæœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* å¦‚æœå…§å®¹éé•·å¯ä»¥æ»¾å‹• */
        }

        /* æ™¯é»ç…§ç‰‡æ¨£å¼ */
        #spot-info-panel .spot-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        #spot-info-panel .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        #spot-info-panel .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        #spot-info-panel h3 {
            margin: 0 0 12px 0;
            color: #2222A0;
            font-size: 18px;
            padding-right: 30px;
        }

        #spot-info-panel p {
            margin: 0 0 8px 0;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }

        #spot-info-panel .tour-btn {
            background: linear-gradient(145deg, #4285f4, #1a73e8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 3px 8px rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #spot-info-panel .tour-btn:hover {
            background: linear-gradient(145deg, #1a73e8, #1557b0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }

        #spot-info-panel .tour-btn:active {
            transform: translateY(0);
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>

<body>
    <div id="æ¨™é¡Œ">
        <img src="../images/taichung.gif" alt="å°ä¸­" />
        å°ä¸­æ™¯é»åœ°åœ–
    </div>

    <!-- é¢æ¿ (åŠ å…¥é è¨­éš±è— class) -->
    <div id="å·¦å´é¢æ¿" class="é¢æ¿éš±è—"></div>
    <div id="å³å´æ§åˆ¶" class="é¢æ¿éš±è—"></div>

    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="åœ°åœ–å®¹å™¨">
        <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="loading-indicator" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
            <p style="margin-top: 20px; color: #1976d2; font-size: 16px;">æ­£åœ¨åŠ è½½åœ°å›¾...</p>
            <p style="color: #666; font-size: 14px;">å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</p>
        </div>
    </div>

    <!-- å³ä¸Šè§’å›ºå®šè³‡è¨Šé¢æ¿ -->
    <div id="spot-info-panel" style="display: none;">
        <button id="close-spot-panel" class="close-btn">Ã—</button>
        <div id="spot-info-content">
            <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
    </div>

    <!-- æ–°å¢çš„å›ºå®šæŒ‰éˆ• -->
    <button id="leftPanelToggle" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" title="åˆ‡æ›æ™¯é»é¢æ¿">ğŸ—ºï¸</button>
    <button id="rightPanelToggle" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" title="åˆ‡æ›è¦–è§’æ§åˆ¶">âš™ï¸</button>

    <script>
        (g => {
            var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
            b = b[c] || (b[c] = {});
            var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                d[q] = f;
                a.onerror = () => h = n(Error(p + " could not load."));
                a.nonce = m.querySelector("script[nonce]")?.nonce || "";
                m.head.append(a)
            }));
            d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
        })({
            key: "AIzaSyDhFmyyK0ipeOreWD1D7Ry4wEE53EudGdA",
            v: "beta"
        });
    </script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        const taichungSpots = [
            {
                name: "å°ä¸­å¸‚æ”¿åºœ",
                pos: { lat: 24.163261, lng: 120.647601, altitude: 200 },
                camera: { center: { lat: 24.163261, lng: 120.647601, altitude: 500 }, range: 5000, tilt: 45, heading: 0 },
                description: "å°ä¸­å¸‚çš„è¡Œæ”¿ä¸­å¿ƒï¼Œç¾ä»£åŒ–å»ºç¯‰ç¾¤",
                icon: "ğŸ›ï¸",
                type: "government",
                image: "../images/image1.jpeg"
            },
            {
                name: "åœ‹ç«‹è‡ªç„¶ç§‘å­¸åšç‰©é¤¨",
                pos: { lat: 24.157936, lng: 120.665982, altitude: 100 },
                camera: { center: { lat: 24.157936, lng: 120.665982, altitude: 300 }, range: 3000, tilt: 45, heading: 0 },
                description: "å°ç£çŸ¥åçš„ç§‘å­¸æ•™è‚²å ´æ‰€ï¼Œé©åˆè¦ªå­åŒéŠ",
                icon: "ğŸ”¬",
                type: "museum",
                image: "../images/image2.jpeg"
            },
            {
                name: "å°ä¸­å…¬åœ’",
                pos: { lat: 24.144592, lng: 120.683923, altitude: 80 },
                camera: { center: { lat: 24.144592, lng: 120.683923, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "å°ä¸­å¸‚ä¸­å¿ƒçš„ç¶ è‰²å¿ƒè‡Ÿï¼Œæ¹–å¿ƒäº­æ˜¯è‘—ååœ°æ¨™",
                icon: "ğŸŒ³",
                type: "park",
                image: "../images/image3.jpeg"
            },
            {
                name: "å½©è™¹çœ·æ‘",
                pos: { lat: 24.133976, lng: 120.610913, altitude: 80 },
                camera: { center: { lat: 24.133976, lng: 120.610913, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "å……æ»¿å½©è‰²å£ç•«çš„çœ·æ‘ï¼Œæ˜¯å°ä¸­è‘—åæ–‡å‰µæ™¯é»",
                icon: "ğŸ¨",
                type: "cultural",
                image: "../images/image4.jpeg"
            },
            {
                name: "ç§‹ç´…è°·å»£å ´",
                pos: { lat: 24.167921, lng: 120.639110, altitude: 80 },
                camera: { center: { lat: 24.167921, lng: 120.639110, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "ä¸‹å‡¹å¼æ™¯è§€å…¬åœ’ï¼Œå¤œæ™šç‡ˆå…‰ç¾è¼ªç¾å¥",
                icon: "ğŸ‚",
                type: "park",
                image: "../images/image5.jpeg"
            },
            {
                name: "é«˜ç¾æ¿•åœ°",
                pos: { lat: 24.305556, lng: 120.561667, altitude: 50 },
                camera: { center: { lat: 24.305556, lng: 120.561667, altitude: 150 }, range: 4000, tilt: 45, heading: 0 },
                description: "å°ç£è¥¿æµ·å²¸é‡è¦æ¿•åœ°ï¼Œè§€è³å¤•é™½çš„çµ•ä½³åœ°é»",
                icon: "ğŸŒ…",
                type: "nature",
                image: "../images/image6.jpeg"
            },
            {
                name: "æ±æµ·å¤§å­¸è·¯æ€ç¾©æ•™å ‚",
                pos: { lat: 24.179055, lng: 120.600997, altitude: 80 },
                camera: { center: { lat: 24.179055, lng: 120.600997, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "å»ºç¯‰å¤§å¸«è²è¿éŠ˜è¨­è¨ˆçš„ç¾ä»£æ•™å ‚å»ºç¯‰",
                icon: "â›ª",
                type: "architecture",
                image: "../images/image7.jpeg"
            },
            {
                name: "ä¸€ä¸­è¡—å•†åœˆ",
                pos: { lat: 24.147736, lng: 120.684436, altitude: 80 },
                camera: { center: { lat: 24.147736, lng: 120.684436, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "å°ä¸­çŸ¥åå¤œå¸‚å•†åœˆï¼Œç¾é£Ÿå°åƒé›†ä¸­åœ°",
                icon: "ğŸœ",
                type: "shopping",
                image: "../images/image8.jpeg"
            },
            {
                name: "å‹¤ç¾èª å“ç¶ åœ’é“",
                pos: { lat: 24.1509963, lng: 120.663848, altitude: 85 },
                camera: { center: { lat: 24.1509963, lng: 120.663848, altitude: 200 }, range: 2500, tilt: 45, heading: 0 },
                description: "çµåˆæ›¸åº—ã€é¤é£²èˆ‡è—æ–‡ç©ºé–“çš„è¤‡åˆå¼æ–‡å‰µå•†å ´",
                icon: "ğŸ“š",
                type: "eslite",
                image: "../images/image9.jpeg"
            }
        ];

        let map3D = null;
        let initialCamera = null;
        let heightPercent = 50;
        let tiltDegrees = null;
        let MapMode = null;

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let isLeftPanelOpen = false;
        let isRightPanelOpen = false;

        async function init() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');

            try {
                const { Map3DElement, MapMode: ImportedMapMode, Marker3DElement, Marker3DInteractiveElement } = await google.maps.importLibrary("maps3d");
                const { PinElement } = await google.maps.importLibrary("marker");

                console.log('âœ… Google Maps 3D API åŠ è½½æˆåŠŸ');

                // å°‡ MapMode è¨­ç‚ºå…¨åŸŸè®Šæ•¸
                MapMode = ImportedMapMode;

                map3D = new Map3DElement({
                    center: { lat: 24.147736, lng: 120.673648, altitude: 2000 },
                    range: 30000,
                    tilt: 30,
                    mode: MapMode.SATELLITE,
                });

                // éš±è—åœ°åœ–åœ°åï¼Œåªé¡¯ç¤ºæ™¯é»åœ–æ¨™
                map3D.addEventListener('gmp-load', () => {
                    if (map3D.map) {
                        map3D.map.setOptions({
                            styles: [{
                                featureType: "all",
                                elementType: "labels",
                                stylers: [{ visibility: "off" }]
                            }]
                        });
                    }
                });

                document.getElementById('åœ°åœ–å®¹å™¨').append(map3D);

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }

                // è¨˜éŒ„åˆå§‹ç›¸æ©Ÿç‹€æ…‹
                initialCamera = {
                    center: {
                        lat: map3D.center.lat,
                        lng: map3D.center.lng,
                        altitude: map3D.center.altitude
                    },
                    range: map3D.range,
                    tilt: map3D.tilt,
                    heading: map3D.heading ?? 0
                };
                tiltDegrees = Math.min(90, Math.max(20, Math.round(initialCamera.tilt)));

                // å»ºç«‹é¢æ¿å…§å®¹
                buildLeftPanel();
                buildRightPanel();

                // è¨­å®šäº‹ä»¶ç›£è½
                setupEventListeners();

                // ç¢ºä¿åœ°åœ–åœ°åè¢«éš±è—
                setTimeout(() => {
                    hideMapLabels();
                }, 1000);

                // æ–°å¢æ™¯é»æ¨™è¨˜
                taichungSpots.forEach(spot => {
                    const marker = new Marker3DInteractiveElement({
                        position: spot.pos,
                        label: `${spot.icon} ${spot.name}`,
                        altitudeMode: "ABSOLUTE",
                        extruded: true,
                    });

                    const pin = new PinElement({
                        background: getMarkerColor(spot.type),
                        borderColor: "#ffffff",
                        glyphColor: getGlyphColor(spot.type),
                        glyph: spot.icon,
                        scale: getMarkerScale(spot.type)
                    });

                    marker.append(pin);

                    marker.addEventListener("gmp-click", (event) => {
                        showFixedSpotPanel(spot);
                        event.stopPropagation();
                    });

                    map3D.append(marker);
                });

            } catch (error) {
                console.error('âŒ åœ°å›¾åŠ è½½å¤±è´¥:', error);
                const container = document.getElementById('åœ°åœ–å®¹å™¨');
                container.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif;">
                        <h2 style="color: #d32f2f;">åœ°å›¾åŠ è½½å¤±è´¥</h2>
                        <p style="color: #666; text-align: center; max-width: 400px;">
                            è¯·åœ¨æ”¯æŒWebGLçš„æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥
                        </p>
                        <p style="color: #1976d2; font-size: 14px;">
                            é”™è¯¯: ${error.message}
                        </p>
                    </div>
                `;
            }
        }

        // ç‚ºä¸åŒé¡å‹æ™¯é»è¨­å®šä¸åŒé¡è‰²
        function getMarkerColor(type) {
            const colors = {
                'government': '#4285f4',
                'museum': '#34a853',
                'park': '#0f9d58',
                'cultural': '#ea4335',
                'nature': '#ff6d01',
                'architecture': '#9c27b0',
                'shopping': '#ff9800',
                'eslite': '#F5E907'
            };
            return colors[type] || '#757575';
        }

        function getGlyphColor(type) {
            const glyphColors = {
                'government': '#ffffff',
                'museum': '#ffffff',
                'park': '#ffff00',
                'cultural': '#ffffff',
                'nature': '#ffffff',
                'architecture': '#ffeb3b',
                'shopping': '#000000',
                'eslite': '#00aa00'
            };
            return glyphColors[type] || '#ffffff';
        }

        function getMarkerScale(type) {
            const scales = {
                'government': 1.5,
                'museum': 1.3,
                'park': 1.4,
                'cultural': 1.2,
                'nature': 1.6,
                'architecture': 1.3,
                'shopping': 1.1,
                'eslite': 1.7
            };
            return scales[type] || 1.2;
        }

        // é¡¯ç¤ºå³ä¸Šè§’å›ºå®šæ™¯é»é¢æ¿
        function showFixedSpotPanel(spot) {
            const panel = document.getElementById('spot-info-panel');
            const content = document.getElementById('spot-info-content');

            content.innerHTML = `
                <h3>${spot.icon} ${spot.name}</h3>
                <img src="${spot.image}" alt="${spot.name}" class="spot-image" onerror="this.style.display='none'">
                <p style="color: #555; margin-bottom: 12px;">${spot.description}</p>
                <p style="font-size: 13px; color: #777; margin-bottom: 8px;">
                    <strong>é¡å‹ï¼š</strong>${getSpotTypeText(spot.type)}
                </p>
                <p style="font-size: 13px; color: #777; margin-bottom: 8px;">
                    <strong>åº§æ¨™ï¼š</strong>${spot.pos.lat.toFixed(4)}, ${spot.pos.lng.toFixed(4)}
                </p>
                <button onclick="startFixedSpotTour('${spot.name}')" class="tour-btn">
                    ğŸ¯ æ™¯é»å°è¦½
                </button>
            `;

            panel.style.display = 'block';
        }

        function getSpotTypeText(type) {
            const typeTexts = {
                'government': 'æ”¿åºœæ©Ÿé—œ',
                'museum': 'åšç‰©é¤¨',
                'park': 'å…¬åœ’ç¶ åœ°',
                'cultural': 'æ–‡åŒ–æ™¯é»',
                'nature': 'è‡ªç„¶æ™¯è§€',
                'architecture': 'å»ºç¯‰æ™¯é»',
                'shopping': 'è³¼ç‰©å•†åœˆ',
                'eslite': 'æ–‡å‰µå•†å ´'
            };
            return typeTexts[type] || 'æ™¯é»';
        }

        function closeFixedSpotPanel() {
            const panel = document.getElementById('spot-info-panel');
            panel.style.display = 'none';
        }

        function startFixedSpotTour(spotName) {
            const spot = taichungSpots.find(s => s.name === spotName);
            if (spot) {
                closeFixedSpotPanel();
                flyToAndRotate(spot);
            }
        }

        // é¡¯ç¤ºåœ°åœ–åœ°å
        function showMapLabels() {
            if (map3D && map3D.map) {
                map3D.map.setOptions({
                    styles: []
                });
            }
        }

        // éš±è—åœ°åœ–åœ°å
        function hideMapLabels() {
            if (map3D && map3D.map) {
                map3D.map.setOptions({
                    styles: [{
                        featureType: "all",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }]
                });
            }
        }

        function flyToAndRotate(spot) {
            map3D.mode = MapMode.HYBRID;
            showMapLabels();

            const closeupCamera = {
                center: { ...spot.pos },
                range: Math.max(spot.camera.range * 0.45, 600) * (heightPercent / 100),
                tilt: tiltDegrees ?? initialCamera.tilt,
                heading: map3D.heading ?? spot.camera.heading ?? 0
            };
            map3D.flyCameraTo({
                endCamera: closeupCamera,
                durationMillis: 5000,
            });
            map3D.addEventListener('gmp-animationend', () => {
                map3D.flyCameraAround({
                    camera: closeupCamera,
                    durationMillis: 6000,
                    rounds: 1
                });

                setTimeout(() => {
                    map3D.mode = MapMode.SATELLITE;
                    hideMapLabels();
                }, 9000);
            }, { once: true });
        }

        function resetToInitial() {
            if (!initialCamera) return;
            heightPercent = 100;
            tiltDegrees = Math.min(90, Math.max(20, Math.round(initialCamera.tilt)));

            map3D.mode = MapMode.SATELLITE;
            hideMapLabels();

            map3D.flyCameraTo({
                endCamera: initialCamera,
                durationMillis: 1200,
            });
            buildRightPanel();
        }

        // --- é¢æ¿å»ºç«‹èˆ‡æ§åˆ¶ ---

        function buildLeftPanel() {
            const panel = document.getElementById('å·¦å´é¢æ¿');
            panel.innerHTML = '';
            taichungSpots.forEach((spot) => {
                const btn = document.createElement('button');
                btn.className = 'æ™¯é»æŒ‰éˆ•';
                btn.textContent = `${spot.icon} ${spot.name}`;
                btn.onclick = () => {
                    showFixedSpotPanel(spot);
                    if (isLeftPanelOpen) {
                        togglePanel('left', false);
                    }
                };
                panel.appendChild(btn);
            });
        }

        function buildRightPanel() {
            const controls = document.getElementById('å³å´æ§åˆ¶');
            controls.innerHTML = '';
            const title = document.createElement('div');
            title.style.fontWeight = 'bold';
            title.style.fontFamily = 'Arial, sans-serif';
            title.textContent = 'è¦–è§’æ§åˆ¶';
            controls.appendChild(title);

            // ä»°è§’æ§åˆ¶
            const tiltGroup = document.createElement('div');
            tiltGroup.className = 'control-group';
            const tiltLabel = document.createElement('label');
            tiltLabel.textContent = `ä»°è§’ï¼š${tiltDegrees}Â°`;
            const tiltInput = document.createElement('input');
            Object.assign(tiltInput, { type: 'range', min: '20', max: '90', step: '5', value: String(tiltDegrees) });
            tiltInput.oninput = () => {
                tiltDegrees = parseInt(tiltInput.value, 10);
                tiltLabel.textContent = `ä»°è§’ï¼š${tiltDegrees}Â°`;
            };
            tiltGroup.append(tiltLabel, tiltInput);
            controls.appendChild(tiltGroup);

            // é«˜åº¦æ§åˆ¶
            const heightGroup = document.createElement('div');
            heightGroup.className = 'control-group';
            const heightLabel = document.createElement('label');
            heightLabel.textContent = `é«˜åº¦ï¼š${heightPercent}%`;
            const heightInput = document.createElement('input');
            Object.assign(heightInput, { type: 'range', min: '20', max: '120', step: '10', value: String(heightPercent) });
            heightInput.oninput = () => {
                heightPercent = parseInt(heightInput.value, 10);
                heightLabel.textContent = `é«˜åº¦ï¼š${heightPercent}%`;
            };
            heightGroup.append(heightLabel, heightInput);
            controls.appendChild(heightGroup);

            // é‡ç½®æŒ‰éˆ•
            const resetBtn = document.createElement('button');
            resetBtn.className = 'æ™¯é»æŒ‰éˆ•';
            resetBtn.textContent = 'é‡ç½®è¦–è§’';
            resetBtn.onclick = resetToInitial;
            controls.appendChild(resetBtn);
        }

        function togglePanel(side, forceState) {
            const isOpen = side === 'left' ? isLeftPanelOpen : isRightPanelOpen;
            const newState = forceState === undefined ? !isOpen : forceState;

            const panel = document.getElementById(side === 'left' ? 'å·¦å´é¢æ¿' : 'å³å´æ§åˆ¶');
            const toggleBtn = document.getElementById(side === 'left' ? 'leftPanelToggle' : 'rightPanelToggle');

            panel.classList.toggle('é¢æ¿éš±è—', !newState);

            if (side === 'left') {
                isLeftPanelOpen = newState;
                toggleBtn.textContent = newState ? 'â¬…ï¸' : 'ğŸ—ºï¸';
            } else {
                isRightPanelOpen = newState;
                toggleBtn.textContent = newState ? 'â¡ï¸' : 'âš™ï¸';
            }
        }

        function setupEventListeners() {
            document.getElementById('leftPanelToggle').onclick = () => togglePanel('left');
            document.getElementById('rightPanelToggle').onclick = () => togglePanel('right');
            document.getElementById('close-spot-panel').onclick = closeFixedSpotPanel;

            // é»æ“Šé¢æ¿å¤–éƒ¨æ™‚ï¼Œé—œé–‰é¢æ¿
            document.getElementById('åœ°åœ–å®¹å™¨').addEventListener('click', () => {
                if(isLeftPanelOpen) togglePanel('left', false);
                if(isRightPanelOpen) togglePanel('right', false);
                closeFixedSpotPanel();
            });

            // æ¨™é¡Œæä¾›é»æ“Šé‡ç½®åŠŸèƒ½
            const header = document.getElementById('æ¨™é¡Œ');
            header.style.cursor = 'pointer';
            header.title = 'é»æ“Šå›åˆ°æœ€åˆè¦–è§’èˆ‡ä½ç½®';
            header.onclick = resetToInitial;
        }

        // ç¨‹å¼é€²å…¥é»
        init();
        console.log('ğŸš€ 3D æ™¯é»åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>