<!DOCTYPE html>
<html>
<head>
    <title>å°ä¸­ YouBike 2.0 åœ°åœ–</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #fff9e6;
        }

        #æ¨™é¡Œ {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgb(34, 34, 150);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 22px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #åœ°åœ–å®¹å™¨ {
            height: 100vh;
            width: 100vw;
        }

        /* å·¦é‚Šä¸­é–“ï¼šYouBike é¢æ¿ */
        #youbikePanel2D {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            padding: 10px 10px 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 220px;
            max-width: 300px;
            transition: all 0.3s ease;
        }

        /* é¢æ¿åˆ‡æ›æŒ‰éˆ• */
        .panel-toggle-btn {
            position: fixed;
            z-index: 25;
            background: rgba(34, 34, 150, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .panel-toggle-btn:hover {
            background: rgb(49, 180, 224);
            transform: scale(1.1);
        }

        #youbikeToggleBtn {
            bottom: 20px;
            left: 20px;
            background: #EEE8AA;
            color: #5a4a00;
        }

        #youbikeToggleBtn:hover {
            background: #e99051;
        }

        /* é¢æ¿éš±è—ç‹€æ…‹ */
        .panel-hidden {
            transform: translateX(-100%) !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #222;
        }

        .control-group input[type="range"] {
            width: 200px;
        }

        .æ™¯é»æŒ‰éˆ• {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #e3eaff;
            color: #222296;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .æ™¯é»æŒ‰éˆ•:hover {
            background: #b6c8ff;
        }
    </style>
</head>

<body>
    <!-- <div id="æ¨™é¡Œ">å°ä¸­ YouBike 2.0 åœ°åœ–</div> -->
    <div id="åœ°åœ–å®¹å™¨"></div>
    <div id="youbikePanel2D"></div>
    
    <!-- æ§åˆ¶æŒ‰éˆ• -->
    <button id="youbikeToggleBtn" class="panel-toggle-btn" title="é¡¯ç¤º/éš±è— YouBike">ğŸš²</button>

    <script>
        (g => {
            var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
            b = b[c] || (b[c] = {});
            var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => {
                await (a = m.createElement("script"));
                e.set("libraries", [...r] + "");
                for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
                e.set("callback", c + ".maps." + q);
                a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
                d[q] = f;
                a.onerror = () => h = n(Error(p + " could not load."));
                a.nonce = m.querySelector("script[nonce]")?.nonce || "";
                m.head.append(a)
            }));
            d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
        })({
            key: "AIzaSyDhFmyyK0ipeOreWD1D7Ry4wEE53EudGdA",
            v: "beta"
        });
    </script>
    <script>
        // YouBike 2D åœ°åœ–è®Šæ•¸
        let map2D = null;
        let youbikeStationsCache = null;
        const map2DMarkers = new Map();
        let filterRadiusMeters2D = 3000;
        let markerSizePx2D = 10;
        let showYouBikeMarkers2D = false; // ä¸€é–‹å§‹ä¸é¡¯ç¤º YouBike æ¨™è¨˜
        let hideMapIcons2D = true;
        let infoWindow2D = null;
        let flutterLocationData = null; // å„²å­˜ Flutter å‚³ä¾†çš„ä½ç½®
        let userLocationMarker = null;  // ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        let lastLocationUpdateTime = 0; // è¨˜éŒ„ä¸Šæ¬¡ä½ç½®æ›´æ–°æ™‚é–“
        let lastSignificantPosition = null; // è¨˜éŒ„ä¸Šæ¬¡é‡è¦ä½ç½®è®Šæ›´
        const LOCATION_UPDATE_INTERVAL = 35000; // 35ç§’æ›´æ–°é–“éš”
        const SIGNIFICANT_MOVE_DISTANCE = 50; // 50å…¬å°ºå…§è¦–ç‚ºç„¡é¡¯è‘—ç§»å‹•

        // 2D åœ°åœ–æ¨£å¼ï¼šéš±è—åœ°å/POI/å¤§çœ¾é‹è¼¸ç­‰åœ–æ¨™
        const MAP_STYLES_HIDE_ICONS = [
            { elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.business', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.park', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            { featureType: 'road', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] }
        ];

        // ç«™åæ¸…ç†ï¼šç§»é™¤å‰ç¶´ "YouBike2.0_"
        function cleanStationName(rawName) {
            const s = String(rawName || '');
            return s.replace(/^YouBike2\.0[_\s-]*/i, '');
        }

        // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—è·é›¢
        function haversineMeters(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Flutter ä½ç½®æ¥æ”¶å‡½æ•¸
        window.receiveFlutterLocation = function(locationData) {
            console.log('âœ… æ”¶åˆ° Flutter ä½ç½®è³‡æ–™:', locationData);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆæ™‚é–“ç¯€æµ + è·é›¢åˆ¤æ–·ï¼‰
            const currentTime = Date.now();
            const timeSinceLastUpdate = currentTime - lastLocationUpdateTime;
            
            // è¨ˆç®—è·é›¢è®ŠåŒ–
            let distanceChanged = Infinity;
            if (lastSignificantPosition) {
                distanceChanged = haversineMeters(
                    lastSignificantPosition.lat, lastSignificantPosition.lng,
                    locationData.lat, locationData.lng
                );
            }
            
            // åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°ï¼šæ™‚é–“é–“éš” OR é¡¯è‘—ç§»å‹•
            const shouldUpdate = timeSinceLastUpdate >= LOCATION_UPDATE_INTERVAL || 
                               distanceChanged >= SIGNIFICANT_MOVE_DISTANCE;
            
            if (!shouldUpdate) {
                console.log(`â±ï¸ è·³éæ›´æ–° - è·é›¢: ${distanceChanged.toFixed(0)}m, æ™‚é–“: ${Math.round(timeSinceLastUpdate/1000)}s`);
                return;
            }
            
            console.log(`ğŸ”„ åŸ·è¡Œä½ç½®æ›´æ–° - è·é›¢è®ŠåŒ–: ${distanceChanged.toFixed(0)}m, æ™‚é–“é–“éš”: ${Math.round(timeSinceLastUpdate/1000)}s`);
            lastLocationUpdateTime = currentTime;
            lastSignificantPosition = { lat: locationData.lat, lng: locationData.lng };
            
            flutterLocationData = locationData;
            
            // å¦‚æœåœ¨ 2D æ¨¡å¼ï¼Œæ›´æ–°åœ°åœ–æ¨™è¨˜
            if (map2D) {
                updateUserLocationMarker(locationData);
            }
        };
        
        // æ›´æ–°ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        function updateUserLocationMarker(locationData) {
            if (!map2D) {
                console.log('âŒ map2D ä¸å­˜åœ¨ï¼Œç„¡æ³•å‰µå»ºæ¨™è¨˜');
                return;
            }
            
            console.log('ğŸ“ é–‹å§‹æ›´æ–°ç”¨æˆ¶ä½ç½®æ¨™è¨˜:', locationData);
            
            const position = { lat: locationData.lat, lng: locationData.lng };
            
            // å¦‚æœæ¨™è¨˜å·²å­˜åœ¨ï¼Œæ›´æ–°ä½ç½®
            if (userLocationMarker) {
                console.log('ğŸ”„ æ›´æ–°ç¾æœ‰æ¨™è¨˜ä½ç½®');
                userLocationMarker.setPosition(position);
            } else {
                console.log('ğŸ†• å‰µå»ºæ–°çš„ä½ç½®æ¨™è¨˜');
                
                // å‰µå»ºæ–°çš„æ¨™è¨˜ - ä½¿ç”¨é†’ç›®çš„è—è‰²åœ“é»
                userLocationMarker = new google.maps.Marker({
                    position: position,
                    map: map2D,
                    title: 'æ‚¨çš„ä½ç½®',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15, // å¢å¤§å°ºå¯¸ä»¥æé«˜å¯è¦‹åº¦
                        fillColor: '#4285F4', // Google è—
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 4 // å¢åŠ ç™½è‰²é‚Šæ¡†å¯¬åº¦
                    },
                    zIndex: 999, // ç¢ºä¿åœ¨æœ€ä¸Šå±¤é¡¯ç¤º
                    optimized: false // é˜²æ­¢è¢«å„ªåŒ–éš±è—
                });
                
                console.log('âœ… ä½ç½®æ¨™è¨˜å·²å‰µå»º:', userLocationMarker);
                
                // æ·»åŠ é»æ“Šäº‹ä»¶é¡¯ç¤ºè¨Šæ¯
                userLocationMarker.addListener('click', () => {
                    console.log('ğŸ” ä½ç½®æ¨™è¨˜è¢«é»æ“Š');
                    const info = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h3>æ‚¨çš„ä½ç½®</h3>
                                <p>ç·¯åº¦: ${locationData.lat.toFixed(6)}</p>
                                <p>ç¶“åº¦: ${locationData.lng.toFixed(6)}</p>
                                <p>ç²¾ç¢ºåº¦: ${locationData.accuracy.toFixed(1)} å…¬å°º</p>
                                <p style="color: #666; font-size: 12px;">è³‡æ–™ä¾†æº: Flutter Geolocator</p>
                            </div>
                        `
                    });
                    info.open(map2D, userLocationMarker);
                });
            }
            
            // ç§»å‹•åœ°åœ–åˆ°ç›®å‰ä½ç½®
            map2D.panTo(position);
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            console.log('ğŸ“ åœ°åœ–å·²ç§»å‹•åˆ°æ‚¨çš„ä½ç½®:', position);
        }

        // è¼‰å…¥ä¸¦æ­£è¦åŒ– YouBike 2.0 è³‡æ–™ï¼ˆä½¿ç”¨ APIï¼‰
        async function loadYouBikeDataNormalized() {
            try {
                // ä½¿ç”¨å°ä¸­å¸‚ YouBike 2.0 API
                const apiUrl = 'https://datacenter.taichung.gov.tw/swagger/OpenData/bc27c2f7-6ed7-4f1a-b3cc-1a3cc9cda34e';
                // const apiUrl = 'https://datacenter.taichung.gov.tw/swagger/OpenData/bc27c2f7-6ed7-4f1a-b3cc-1a3cc9cda34e';   

                console.log('ğŸŒ å¾ API è¼‰å…¥ YouBike è³‡æ–™...');
                
                const resp = await fetch(apiUrl, { 
                    cache: 'no-store',
                    mode: 'cors'
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}: ç„¡æ³•è¼‰å…¥ YouBike è³‡æ–™`);
                const raw = await resp.json();
                
                if (raw.retCode !== 1) throw new Error(`API å›å‚³éŒ¯èª¤ä»£ç¢¼: ${raw.retCode}`);
                const stations = Array.isArray(raw.retVal) ? raw.retVal : [];
                
                const normalized = stations.map((station, idx) => {
                    const id = String(station.sno || idx);
                    const name = cleanStationName(station.sna || `æœªçŸ¥ç«™é»${idx}`);
                    const area = String(station.sarea || '');
                    const address = String(station.ar || '');
                    const lat = Number(station.lat);
                    const lng = Number(station.lng);
                    const totalSlots = Number(station.tot || 0);
                    const bikes = Number(station.sbi || 0);
                    const docks = Number(station.bemp || 0);
                    const isActive = station.act === 1;
                    const yb2Bikes = Number(station.sbi_detail?.yb2 || 0);
                    const electricBikes = Number(station.sbi_detail?.eyb || 0);
                    const lastUpdate = station.mday || '';
                    return { id, name, area, address, lat, lng, bikes, docks, totalSlots, yb2Bikes, electricBikes, isActive, lastUpdate };
                }).filter(station => Number.isFinite(station.lat) && Number.isFinite(station.lng) && station.isActive);
                
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${normalized.length} å€‹ YouBike ç«™é»`);
                return normalized;
                
            } catch (err) {
                console.error('[YouBike 2D] API è¼‰å…¥å¤±æ•—ï¼š', err);
                return [];
            }
        }

        // æ ¹æ“šç«™é»ç‹€æ…‹æ±ºå®šé¡¯ç¤ºæ¨£å¼å’Œæ–‡å­—
        function getStationStatus(station) {
            const { bikes, docks, totalSlots } = station;
            
            let statusSymbol, statusText;
            
            if (bikes === 0 && docks === 0) {
                statusSymbol = 'ğŸ”´';
                statusText = 'ç¶­è­·ä¸­';
            } else if (bikes === 0) {
                statusSymbol = 'ğŸŸ¡';
                statusText = 'ç„¡è»Šå¯å€Ÿ';
            } else if (docks === 0) {
                statusSymbol = 'ğŸŸ¡';
                statusText = 'ç„¡ä½å¯é‚„';
            } else if (bikes <= 2 || docks <= 2) {
                statusSymbol = 'ğŸŸ ';
                statusText = 'è»Šä½ä¸è¶³';
            } else {
                statusSymbol = 'ğŸŸ¢';
                statusText = 'æ­£å¸¸é‹ä½œ';
            }
            
            return { statusSymbol, statusText };
        }

        // åˆå§‹åŒ– 2D åœ°åœ–
        async function init2DMap() {
            try {
                await google.maps.importLibrary('maps');
                
                const container = document.getElementById('åœ°åœ–å®¹å™¨');
                const mapDiv = document.createElement('div');
                mapDiv.style.width = '100%';
                mapDiv.style.height = '100vh';
                container.appendChild(mapDiv);
                
                map2D = new google.maps.Map(mapDiv, {
                    center: { lat: 24.147736, lng: 120.673648 },
                    zoom: 13,
                    mapTypeId: 'roadmap',
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_LEFT,
                        mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
                    },
                    zoomControl: false, // é€™è£¡è¨­ç‚º falseï¼Œéš±è— + - æŒ‰éˆ•
                    scaleControl: true,
                    streetViewControl: false,
                    fullscreenControl: false
                });

                // å»ºç«‹è‡ªè¨‚ã€Œç›®å‰ä½ç½®ã€æŒ‰éˆ•
                const locationButton = document.createElement("button");
                locationButton.textContent = "ğŸ”˜";
                locationButton.classList.add("panel-toggle-btn");
                locationButton.style.position = "fixed";      // ç”¨ fixed
                locationButton.style.right = "10px";          // ä½ è¦çš„è·é›¢
                locationButton.style.bottom = "110px";
                locationButton.style.left = "auto";
                locationButton.style.width = "44px";
                locationButton.style.height = "44px";
                locationButton.style.borderRadius = "50%";
                locationButton.style.fontSize = "24px";
                locationButton.style.padding = "0";
                locationButton.style.background = "#fff";
                locationButton.style.color = "#222296";
                locationButton.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
                locationButton.style.zIndex = "40";
                locationButton.onclick = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const pos = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                map2D.setCenter(pos);
                                // å¯é¸ï¼šåŠ ä¸€å€‹ marker
                                if (!window.currentLocationMarker) {
                                    window.currentLocationMarker = new google.maps.Marker({
                                        position: pos,
                                        map: map2D,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            scale: 10,
                                            fillColor: "#4285F4",
                                            fillOpacity: 1,
                                            strokeColor: "#fff",
                                            strokeWeight: 2
                                        }
                                    });
                                } else {
                                    window.currentLocationMarker.setPosition(pos);
                                }
                            },
                            () => {
                                alert("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®");
                            }
                        );
                    } else {
                        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                    }
                };
                // ç›´æ¥åŠ åˆ° body
                document.body.appendChild(locationButton);

                // å»ºç«‹è³‡è¨Šè¦–çª—
                infoWindow2D = new google.maps.InfoWindow();

                // å¥—ç”¨éš±è—åœ°ååœ–æ¨™æ¨£å¼
                if (hideMapIcons2D) {
                    map2D.setOptions({ styles: MAP_STYLES_HIDE_ICONS });
                }

                // è¼‰å…¥ YouBike è³‡æ–™
                youbikeStationsCache = await loadYouBikeDataNormalized();
                console.log(`è¼‰å…¥ ${youbikeStationsCache.length} å€‹ YouBike ç«™é»`);

                // å»ºç«‹æ§åˆ¶é¢æ¿
                buildYouBike2DPanel();

                // è¨­å®šæŒ‰éˆ•åŠŸèƒ½
                setupControlButtons();

                // å„ªå…ˆä½¿ç”¨ Flutter ä½ç½®ï¼Œå¦å‰‡ä½¿ç”¨ç€è¦½å™¨å®šä½
                const useCenterAndRender = async (center) => {
                    map2D.setCenter(center);
                    map2D.setZoom(16);  // æ”¾å¤§åˆ°æ›´è©³ç´°çš„ç´šåˆ¥
                    if (!youbikeStationsCache) youbikeStationsCache = await loadYouBikeDataNormalized();
                    // render2DYouBikeMarkers(center); // ç­‰ç”¨æˆ¶é–‹å•Ÿé¡¯ç¤ºé–‹é—œ
                };
                
                // å¦‚æœå·²æœ‰ Flutter ä½ç½®è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨
                if (flutterLocationData) {
                    console.log('ä½¿ç”¨ Flutter ä½ç½®è³‡æ–™');
                    const currentUserPosition = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
                    updateUserLocationMarker(flutterLocationData);
                    useCenterAndRender(currentUserPosition);
                } else if (navigator.geolocation) {
                    // Web å¹³å°ï¼šä½¿ç”¨ç€è¦½å™¨å®šä½ API
                    navigator.geolocation.getCurrentPosition(
                        (pos) => { 
                            console.log('ç€è¦½å™¨å®šä½æˆåŠŸ:', pos.coords);
                            const currentUserPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            
                            // å‰µå»ºè—è‰²å®šä½æ¨™è¨˜
                            const locationData = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy
                            };
                            updateUserLocationMarker(locationData);
                            useCenterAndRender(currentUserPosition);
                        },
                        (error) => {
                            console.log('ç€è¦½å™¨å®šä½å¤±æ•—:', error);
                            useCenterAndRender({ lat: 24.147736, lng: 120.673648 });
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                    );
                } else {
                    useCenterAndRender({ lat: 24.147736, lng: 120.673648 });
                }

                // ç•¶åœ°åœ–ç§»å‹•æ™‚æ›´æ–°ç«™é»
                map2D.addListener('idle', () => {
                    const c = map2D.getCenter();
                    if (!c) return;
                    // ===== æ–°å¢æ¢ä»¶ï¼šåªæœ‰é–‹é—œç‚ºé–‹æ‰æ¸²æŸ“ =====
                    if (showYouBikeMarkers2D) {
                        render2DYouBikeMarkers({ lat: c.lat(), lng: c.lng() });
                    } else {
                        clearAllMarkers();
                        // æ›´æ–°çµ±è¨ˆæ•¸å­—ç‚º 0
                        const countEl = document.getElementById('youbikeCount2D');
                        if (countEl) countEl.textContent = `é¡¯ç¤ºç«™é»ï¼š0ï¼ç¸½ ${youbikeStationsCache ? youbikeStationsCache.length : 0}ï¼ˆåŠå¾‘ ${filterRadiusMeters2D} mï¼‰`;
                    }
                });

            } catch (error) {
                console.error('åˆå§‹åŒ– 2D åœ°åœ–å¤±æ•—:', error);
            }
        }

        // è¨­å®šæ§åˆ¶æŒ‰éˆ•åŠŸèƒ½
        function setupControlButtons() {
            // YouBike é¢æ¿åˆ‡æ›
            const youbikeToggleBtn = document.getElementById('youbikeToggleBtn');
            const youbikePanel = document.getElementById('youbikePanel2D');
            let panelVisible = false; // ä¸€é–‹å§‹éš±è—é¢æ¿
            
            // åˆå§‹è¨­å®šé¢æ¿ç‚ºéš±è—ç‹€æ…‹
            youbikePanel.classList.add('panel-hidden');
            youbikeToggleBtn.textContent = 'ğŸ‘ï¸';
            youbikeToggleBtn.title = 'é¡¯ç¤º YouBike é¢æ¿';

            youbikeToggleBtn.onclick = () => {
                panelVisible = !panelVisible;
                if (panelVisible) {
                    youbikePanel.classList.remove('panel-hidden');
                    youbikeToggleBtn.textContent = 'ğŸš²';
                    youbikeToggleBtn.title = 'éš±è— YouBike é¢æ¿';
                } else {
                    youbikePanel.classList.add('panel-hidden');
                    youbikeToggleBtn.textContent = 'ğŸ‘ï¸';
                    youbikeToggleBtn.title = 'é¡¯ç¤º YouBike é¢æ¿';
                }
            };

            // ç§»é™¤ç›®å‰ä½ç½®æŒ‰éˆ•ç›¸é—œä»£ç¢¼
        }


        // å»ºç«‹ YouBike æ§åˆ¶é¢æ¿
        function buildYouBike2DPanel() {
            const panel = document.getElementById('youbikePanel2D');
            if (!panel) return;
            panel.innerHTML = '';

            const title = document.createElement('div');
            title.style.fontWeight = 'bold';
            title.style.fontFamily = 'Arial, sans-serif';
            title.textContent = 'YouBike 2.0 å–®è»Šç«™é»';
            panel.appendChild(title);

            // é¡è‰²åœ–ä¾‹
            const legend = document.createElement('div');
            legend.style.fontFamily = 'Arial, sans-serif';
            legend.style.fontSize = '12px';
            legend.style.margin = '4px 0 6px 0';
            legend.innerHTML = `
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <span>åœ–ä¾‹ï¼š</span>
  <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#34a853;border:1px solid #333;display:inline-block"></span>æ­£å¸¸</span>
  <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#f29900;border:1px solid #333;display:inline-block"></span>ä¸è¶³</span>
  <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#fbbc04;border:1px solid #333;display:inline-block"></span>ç„¡è»Š/ç„¡ä½</span>
  <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#d93025;border:1px solid #333;display:inline-block"></span>ç¶­è­·</span>
</div>`;
            panel.appendChild(legend);

            // å–®è»Šé¡¯ç¤ºé–‹é—œ
            const toggleGroup = document.createElement('div');
            toggleGroup.id = 'youbike-toggle';
            toggleGroup.style.marginBottom = '16px';
            toggleGroup.style.textAlign = 'center';

            const toggleButton = document.createElement('button');
            toggleButton.id = 'toggleYouBike';
            toggleButton.style.fontSize = '1.2em';
            toggleButton.style.padding = '8px 24px';
            toggleButton.innerHTML = `ğŸš² å–®è»Šé¡¯ç¤ºï¼š<span id="youbike-status">é–‹</span>`;
            toggleButton.onclick = () => {
                showYouBikeMarkers2D = !showYouBikeMarkers2D;
                const statusText = document.getElementById('youbike-status');
                if (showYouBikeMarkers2D) {
                    statusText.textContent = 'é–‹';
                    const c = map2D.getCenter();
                    if (c) render2DYouBikeMarkers({ lat: c.lat(), lng: c.lng() });
                } else {
                    statusText.textContent = 'é—œ';
                    clearAllMarkers();
                }
            };
            toggleGroup.appendChild(toggleButton);
            panel.appendChild(toggleGroup);

            // æœå°‹åŠå¾‘æ§åˆ¶
            const radiusGroup = document.createElement('div');
            radiusGroup.className = 'control-group';
            const radiusLabel = document.createElement('label');
            radiusLabel.textContent = `æœå°‹åŠå¾‘ï¼š${Math.round(filterRadiusMeters2D)} å…¬å°º`;
            const radiusInput = document.createElement('input');
            radiusInput.type = 'range';
            radiusInput.min = '300';
            radiusInput.max = '3000';
            radiusInput.step = '100';
            radiusInput.value = String(filterRadiusMeters2D);
            radiusInput.oninput = () => {
                filterRadiusMeters2D = parseInt(radiusInput.value, 10);
                radiusLabel.textContent = `æœå°‹åŠå¾‘ï¼š${filterRadiusMeters2D} å…¬å°º`;
                const c = map2D.getCenter();
                if (c) render2DYouBikeMarkers({ lat: c.lat(), lng: c.lng() });
            };
            radiusGroup.appendChild(radiusLabel);
            radiusGroup.appendChild(radiusInput);
            panel.appendChild(radiusGroup);

            // åœ–æ¨™å¤§å°æ§åˆ¶
            const sizeGroup = document.createElement('div');
            sizeGroup.className = 'control-group';
            const sizeLabel = document.createElement('label');
            sizeLabel.textContent = `åœ–æ¨™å¤§å°ï¼š${markerSizePx2D}px`;
            const sizeInput = document.createElement('input');
            sizeInput.type = 'range';
            sizeInput.min = '6';
            sizeInput.max = '16';
            sizeInput.step = '1';
            sizeInput.value = String(markerSizePx2D);
            sizeInput.oninput = () => {
                markerSizePx2D = parseInt(sizeInput.value, 10);
                sizeLabel.textContent = `åœ–æ¨™å¤§å°ï¼š${markerSizePx2D}px`;
                const c = map2D.getCenter();
                if (c) render2DYouBikeMarkers({ lat: c.lat(), lng: c.lng() });
            };
            sizeGroup.appendChild(sizeLabel);
            sizeGroup.appendChild(sizeInput);
            panel.appendChild(sizeGroup);

            // é¡¯ç¤ºçµ±è¨ˆ
            const countEl = document.createElement('div');
            countEl.id = 'youbikeCount2D';
            countEl.style.fontFamily = 'Arial, sans-serif';
            countEl.style.fontSize = '12px';
            countEl.style.marginTop = '4px';
            panel.appendChild(countEl);
        }

        // æ¸²æŸ“ YouBike æ¨™è¨˜
        function render2DYouBikeMarkers(center) {
            // ===== æ–°å¢æ¢ä»¶ï¼šåªæœ‰é–‹é—œç‚ºé–‹æ‰é¡¯ç¤º =====
            if (!showYouBikeMarkers2D) {
                clearAllMarkers();
                // æ›´æ–°çµ±è¨ˆæ•¸å­—ç‚º 0
                const countEl = document.getElementById('youbikeCount2D');
                if (countEl) countEl.textContent = `é¡¯ç¤ºç«™é»ï¼š0ï¼ç¸½ ${youbikeStationsCache ? youbikeStationsCache.length : 0}ï¼ˆåŠå¾‘ ${filterRadiusMeters2D} mï¼‰`;
                return;
            }

            if (!Array.isArray(youbikeStationsCache) || !map2D) return;

            // è¨ˆç®—è·é›¢
            const R = 6371000;
            const toRad = (d) => d * Math.PI / 180;
            const dist = (a, b) => {
                const dLat = toRad(b.lat - a.lat);
                const dLng = toRad(b.lng - a.lng);
                const s = Math.sin(dLat/2) ** 2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng/2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
                return R * c;
            };

            // ç¯©é¸ç¯„åœå…§çš„ç«™é»
            const within = youbikeStationsCache.filter(st => {
                if (!st.isActive) return false;
                const d = dist(center, { lat: st.lat, lng: st.lng });
                return d <= filterRadiusMeters2D;
            });

            // æ¸…é™¤èˆŠæ¨™è¨˜
            clearAllMarkers();

            // å»ºç«‹æ–°æ¨™è¨˜
            within.forEach(station => {
                const color = statusColorForStation(station);
                const marker = new google.maps.Marker({
                    position: { lat: station.lat, lng: station.lng },
                    map: map2D,
                    title: `${station.name}ï½œå€Ÿ:${station.bikes} é‚„:${station.docks}`,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: markerSizePx2D,
                        fillColor: color,
                        fillOpacity: 0.8,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    }
                });

                marker.addListener('click', () => {
                    const { statusSymbol, statusText } = getStationStatus(station);
                    
                    // è¨ˆç®—è·é›¢å’Œæ™‚é–“
                    const distanceInfo = calculateDistanceAndTime(station);
                    
                    const html = `
<div style="font-family:Arial, sans-serif; min-width: 220px;">
  <div style="font-weight:700;font-size:18px;margin-bottom:8px;">${station.name}</div>
  <div style="font-size:14px;margin-bottom:8px;">ç‹€æ…‹: ${statusSymbol} ${statusText}</div>
  ${distanceInfo}
  <div style="font-size:14px;line-height:1.5;">
    <div>ğŸš² å¯å€Ÿè»Šè¼›ï¼š${station.bikes}</div>
    <div>ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š${station.docks}</div>
    <div>ğŸ“Š ç¸½è»Šä½æ•¸ï¼š${station.totalSlots}</div>
    <div>âš¡ é›»å‹•è»Šï¼š${station.electricBikes}</div>
  </div>
</div>`;
                    infoWindow2D.setContent(html);
                    infoWindow2D.open({ map: map2D, anchor: marker });
                });

                map2DMarkers.set(station.id, marker);
            });

            // æ›´æ–°çµ±è¨ˆ
            const countEl = document.getElementById('youbikeCount2D');
            if (countEl) {
                countEl.textContent = `é¡¯ç¤ºç«™é»ï¼š${within.length}ï¼ç¸½ ${youbikeStationsCache.length}ï¼ˆåŠå¾‘ ${filterRadiusMeters2D} mï¼‰`;
            }
        }

        // ç«™é»ç‹€æ…‹é¡è‰²
        function statusColorForStation(st) {
            const bikes = st.bikes || 0;
            const docks = st.docks || 0;
            if (bikes === 0 && docks === 0) return '#d93025'; // ç´…
            if (bikes === 0 || docks === 0) return '#fbbc04'; // é»ƒ
            if (bikes <= 2 || docks <= 2) return '#f29900'; // æ©™
            return '#34a853'; // ç¶ 
        }

        // æ¸…é™¤æ‰€æœ‰ YouBike æ¨™è¨˜
        function clearAllMarkers() {
            map2DMarkers.forEach(mk => mk.setMap(null));
            map2DMarkers.clear();
            // æ–°å¢ï¼šé—œé–‰ infoWindow
            if (infoWindow2D) infoWindow2D.close();
        }

        // è¨ˆç®—è·é›¢å’Œæ™‚é–“
        function calculateDistanceAndTime(station) {
            // å–å¾—ç›®å‰ä½ç½®ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            let currentPos = null;
            
            // å˜—è©¦å¾åœ°åœ–ä¸­å¿ƒå–å¾—ä½ç½®
            if (map2D) {
                const center = map2D.getCenter();
                if (center) {
                    currentPos = { lat: center.lat(), lng: center.lng() };
                }
            }
            
            // å¦‚æœæœ‰ç›®å‰ä½ç½®æ¨™è¨˜ï¼Œä½¿ç”¨è©²ä½ç½®
            if (window.currentLocationMarker) {
                const pos = window.currentLocationMarker.getPosition();
                if (pos) {
                    currentPos = { lat: pos.lat(), lng: pos.lng() };
                }
            }
            
            if (!currentPos) {
                return '<div style="font-size:12px;color:#666;margin-bottom:6px;">ğŸ“ ç„¡æ³•å–å¾—ç›®å‰ä½ç½®</div>';
            }
            
            // è¨ˆç®—ç›´ç·šè·é›¢ï¼ˆå…¬å°ºï¼‰
            const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(station.lat - currentPos.lat);
            const dLng = toRad(station.lng - currentPos.lng);
            const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(currentPos.lat)) * Math.cos(toRad(station.lat)) * Math.sin(dLng/2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            
            // æ ¼å¼åŒ–è·é›¢
            let distanceText;
            if (distance < 1000) {
                distanceText = `${Math.round(distance)} å…¬å°º`;
            } else {
                distanceText = `${(distance / 1000).toFixed(1)} å…¬é‡Œ`;
            }
            
            // ä¼°ç®—æ™‚é–“ï¼ˆå‡è¨­æ­¥è¡Œé€Ÿåº¦ 5 km/hï¼Œé¨è»Šé€Ÿåº¦ 15 km/hï¼‰
            const walkingTimeMinutes = Math.round((distance / 1000) / 5 * 60);
            const cyclingTimeMinutes = Math.round((distance / 1000) / 15 * 60);
            
            let walkingTimeText, cyclingTimeText;
            
            if (walkingTimeMinutes < 60) {
                walkingTimeText = `${walkingTimeMinutes} åˆ†é˜`;
            } else {
                const hours = Math.floor(walkingTimeMinutes / 60);
                const minutes = walkingTimeMinutes % 60;
                walkingTimeText = `${hours} å°æ™‚ ${minutes} åˆ†é˜`;
            }
            
            if (cyclingTimeMinutes < 60) {
                cyclingTimeText = `${cyclingTimeMinutes} åˆ†é˜`;
            } else {
                const hours = Math.floor(cyclingTimeMinutes / 60);
                const minutes = cyclingTimeMinutes % 60;
                cyclingTimeText = `${hours} å°æ™‚ ${minutes} åˆ†é˜`;
            }
            
            return `
<div style="font-size:12px;color:#666;margin-bottom:6px;padding:4px;background:#f5f5f5;border-radius:4px;">
  <div>ğŸ“ è·é›¢ï¼š${distanceText}</div>
  <div>ğŸš¶ æ­¥è¡Œç´„ï¼š${walkingTimeText}</div>
  <div>ğŸš´ é¨è»Šç´„ï¼š${cyclingTimeText}</div>
</div>`;
        }

        // åˆå§‹åŒ–ä¸¦å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', () => {
            init2DMap();
            console.log('ğŸš€ YouBike 2D åœ°åœ–åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>