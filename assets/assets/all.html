<!DOCTYPE html>
<html>
<head>
    <title>å°ä¸­æ™¯é» 3D åœ°åœ–</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #fff9e6;
        }

        #æ¨™é¡Œ {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgb(34, 34, 150);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            font-size: 22px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #æ¨™é¡Œ:hover {
            background-color: rgb(49, 49, 180);
        }

        #åœ°åœ–å®¹å™¨ {
            height: 100vh;
            width: 100vw;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        #å·¦å´é¢æ¿ {
            position: fixed;
            top: 90px;
            left: 30px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 12px 10px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #å³å´æ§åˆ¶ {
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 10px 10px 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }

        /* å·¦ä¸‹è§’ï¼š2D ç”¨ YouBike é¢æ¿ */
        #youbikePanel2D {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            padding: 10px 10px 8px 10px;
            display: none; /* é è¨­éš±è—ï¼Œ2D é¡¯ç¤º */
            flex-direction: column;
            gap: 6px;
            min-width: 220px;
            max-width: 300px;
        }

        /* 2D å·¦ä¸‹è§’é¢æ¿åˆ‡æ›æŒ‰éˆ•ï¼ˆé¡¯ç¤º/éš±è— Ubike é¢æ¿ï¼‰ */
        #youbikeToggleBtn {
            position: fixed;
            bottom: 70px;
            left: 20px; /* èˆ‡é¢æ¿éŒ¯é–‹ï¼Œé¿å…é®è“‹ */
            z-index: 25;
            width: 44px;
            height: 44px;
            background: #EEE8AA; /* æ·¡é»ƒé‡‘ */
            color: #5a4a00;
        }
        #youbikeToggleBtn:hover { background: #e99051; }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #222;
        }

        .control-group input[type="range"] {
            width: 200px;
        }

        .æ™¯é»æŒ‰éˆ• {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #e3eaff;
            color: #222296;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .æ™¯é»æŒ‰éˆ•:hover {
            background: #b6c8ff;
        }

        #ç›¸æ©Ÿè³‡è¨Š {
            position: fixed;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            width: 100vw;
            font-size: 15px;
            z-index: 30;
            box-sizing: border-box;
            max-height: 40vh;
            overflow-y: auto;
            border-top: 2px solid rgba(34, 34, 150, 0.3);
            transition: transform 0.3s ease;
        }
        
        #ç›¸æ©Ÿè³‡è¨Š.éš±è— {
            transform: translateY(100%);
        }

        #ç›¸æ©Ÿåƒæ•¸é¡¯ç¤º {
            margin-bottom: 8px;
            font-weight: bold;
        }

        /* æ‘ºç–ŠæŒ‰éˆ• */
        #toggleDebugBtn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 35;
            background: rgba(34, 34, 150, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: none; /* é è¨­éš±è—ï¼Œåªåœ¨æœ‰å®šä½è³‡æ–™æ™‚é¡¯ç¤º */
        }
        
        #toggleDebugBtn:hover {
            background: rgba(49, 49, 180, 1);
        }
        
        #åµéŒ¯è³‡è¨Šå€å¡Š {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        #åµéŒ¯æ¨™é¡Œ {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        #åµéŒ¯æ¨™é¡Œ:hover {
            color: #222296;
        }

        #åµéŒ¯å…§å®¹ {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.04);
            padding: 6px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .åµéŒ¯æ‘ºç–Š {
            max-height: 0 !important;
            padding: 0 6px !important;
            opacity: 0;
        }

        /* é¢æ¿åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .é¢æ¿åˆ‡æ›æŒ‰éˆ• {
            position: fixed;
            z-index: 25;
            background: rgba(34, 34, 150, 0.95);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .é¢æ¿åˆ‡æ›æŒ‰éˆ•:hover {
            background: rgb(49, 180, 224);
            transform: scale(1.1);
        }

        /* å³å´æŒ‰éˆ•ï¼šæ·¡é»ƒé‡‘åº•è‰²èˆ‡å°æ‡‰ hover æ•ˆæœ */
        #å³å´åˆ‡æ›,
        #mapToggleBtn,
        #locationBtn {
            background: #EEE8AA; /* palegoldenrod æ·¡é»ƒé‡‘ */
            color: #5a4a00;
        }
        #å³å´åˆ‡æ›:hover,
        #mapToggleBtn:hover,
        #locationBtn:hover {
            background: #edba7f; /* ç¨å¾®åŠ æ·±çš„æ·¡é»ƒé‡‘ */
        }

        /* å³å´é¢æ¿ä¸­çš„åŠŸèƒ½æŒ‰éˆ•ä½¿ç”¨æ·¡é»ƒé‡‘åº•è‰²ï¼Œä¸å½±éŸ¿å·¦å´é¢æ¿æŒ‰éˆ• */
        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ• {
            background: #F7E7A1;
            color: #5a4a00;
        }
        #å³å´æ§åˆ¶ .æ™¯é»æŒ‰éˆ•:hover {
            background: #E9D784;
        }

        #leftPanelToggle {
            top: 70px;
            left: 15px;
        }
        #rightPanelToggle {
            top: 70px;
            right: 15px;
        }

        /* é¢æ¿éš±è—ç‹€æ…‹ */
        .é¢æ¿éš±è— {
            opacity: 0;
            pointer-events: none;
        }

        /* é¢æ¿éæ¸¡å‹•ç•« */
        #å·¦å´é¢æ¿, #å³å´æ§åˆ¶, #youbikePanel2D {
            transition: all 0.3s ease;
        }

        .youbikeé¢æ¿éš±è— {
            transform: translateY(110%) !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>
</head>

<body>
    <button id="leftPanelToggle" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" title="åˆ‡æ›æ™¯é»é¢æ¿" aria-label="åˆ‡æ›æ™¯é»é¢æ¿" role="button">ğŸ—ºï¸</button>
    <button id="rightPanelToggle" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" title="åˆ‡æ›è¦–è§’æ§åˆ¶" aria-label="åˆ‡æ›è¦–è§’æ§åˆ¶" role="button">âš™ï¸</button>
    <div id="æ¨™é¡Œ">å°ä¸­æ™¯é»</div>
    <!-- ç§»é™¤æµ®å‹•åˆ‡æ›æŒ‰éˆ•ï¼Œåœ¨ Flutter ä¸­ä¸éœ€è¦ ? -->
    <div id="å·¦å´é¢æ¿"></div>
    <div id="åœ°åœ–å®¹å™¨" style="height:100vh;width:100vw;"></div>
    <div id="å³å´æ§åˆ¶"></div>
    <div id="youbikePanel2D"></div>
    <button id="mapToggleBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 80px; right: 70px;" title="åˆ‡æ›åœ°åœ–æ¨¡å¼" aria-label="åˆ‡æ›åœ°åœ–æ¨¡å¼" role="button">ğŸ§Š</button>
    <button id="locationBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 140px; right: 70px; display: none;" title="ç§»å‹•åˆ°ç›®å‰ä½ç½®" aria-label="ç§»å‹•åˆ°ç›®å‰ä½ç½®" role="button">ğŸ”˜</button>
    <button id="youbikeToggleBtn" class="é¢æ¿åˆ‡æ›æŒ‰éˆ•" style="position: fixed; bottom: 80px; right: 20px;" title="é¡¯ç¤º/éš±è— YouBike é¢æ¿" aria-label="é¡¯ç¤º/éš±è— YouBike é¢æ¿" role="button">ğŸš²</button>
    <button id="toggleDebugBtn" title="é¡¯ç¤º/éš±è—å®šä½è³‡è¨Š" aria-label="é¡¯ç¤º/éš±è—å®šä½è³‡è¨Š" role="button">ğŸ“</button>
    <div id="ç›¸æ©Ÿè³‡è¨Š" class="éš±è—">
        <div id="ç›¸æ©Ÿåƒæ•¸é¡¯ç¤º" style="display: none;"><!-- æš«æ™‚éš±è—ç›¸æ©Ÿåƒæ•¸ --></div>
        <div id="åµéŒ¯è³‡è¨Šå€å¡Š">
            <div id="åµéŒ¯æ¨™é¡Œ">å®šä½è³‡è¨Š (é»æ“Šå±•é–‹/æ‘ºç–Š)</div>
            <div id="åµéŒ¯å…§å®¹">ç­‰å¾…å®šä½ä¸­...</div>
        </div>
    </div>
    <script async defer>
        console.log('ğŸš€ é–‹å§‹è¼‰å…¥ Google Maps API...');
        console.log('ğŸ“ ç•¶å‰ç¶²åŸŸ:', window.location.href);
        
        (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; console.log('ğŸ“¡ è¼‰å…¥ Maps API URL:', a.src); d[q] = f; a.onerror = (err) => { console.error('âŒ Google Maps API è¼‰å…¥å¤±æ•—:', err); h = n(Error(p + " could not load.")); }; a.onload = () => { console.log('âœ… Google Maps API è…³æœ¬è¼‰å…¥æˆåŠŸ'); }; a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
            key: "AIzaSyDhFmyyK0ipeOreWD1D7Ry4wEE53EudGdA",
            v: "beta",
        });
        
        // ç›£è½ Google Maps API è¼‰å…¥å®Œæˆ
        window.addEventListener('load', () => {
            console.log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ');
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²å¯ç”¨');
            } else {
                console.log('âŒ Google Maps API ä¸å¯ç”¨');
            }
        });
    </script>
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        const taichungSpots = [
            { name: "å°ä¸­å¸‚æ”¿åºœ", pos: { lat: 24.163261, lng: 120.647601, altitude: 200 }, camera: { center: { lat: 24.163261, lng: 120.647601, altitude: 500 }, range: 5000, tilt: 45, heading: 0 } },
            { name: "åœ‹ç«‹è‡ªç„¶ç§‘å­¸åšç‰©é¤¨", pos: { lat: 24.157936, lng: 120.665982, altitude: 100 }, camera: { center: { lat: 24.157936, lng: 120.665982, altitude: 300 }, range: 3000, tilt: 45, heading: 0 } },
            { name: "å°ä¸­å…¬åœ’", pos: { lat: 24.144592, lng: 120.683923, altitude: 80 }, camera: { center: { lat: 24.144592, lng: 120.683923, altitude: 200 }, range: 2500, tilt: 45, heading: 0 } },
            { name: "å½©è™¹çœ·æ‘", pos: { lat: 24.133976, lng: 120.610913, altitude: 80 }, camera: { center: { lat: 24.133976, lng: 120.610913, altitude: 200 }, range: 2500, tilt: 45, heading: 0 } },
            { name: "ç§‹ç´…è°·å»£å ´", pos: { lat: 24.167921, lng: 120.639110, altitude: 80 }, camera: { center: { lat: 24.167921, lng: 120.639110, altitude: 200 }, range: 2500, tilt: 45, heading: 0 } },
            { name: "é«˜ç¾æ¿•åœ°", pos: { lat: 24.305556, lng: 120.561667, altitude: 50 }, camera: { center: { lat: 24.305556, lng: 120.561667, altitude: 150 }, range: 4000, tilt: 45, heading: 0 } },
            { name: "æ±æµ·å¤§å­¸è·¯æ€ç¾©æ•™å ‚", pos: { lat: 24.179055, lng: 120.600997, altitude: 80 }, camera: { center: { lat: 24.179055, lng: 120.600997, altitude: 200 }, range: 2500, tilt: 45, heading: 0 } },
            { name: "ä¸€ä¸­è¡—å•†åœˆ", pos: { lat: 24.147736, lng: 120.684436, altitude: 80 }, camera: { center: { lat: 24.147736, lng: 120.684436, altitude: 200 }, range: 2500, tilt: 45, heading: 0 } }
        ];
        let map3D, map2D, initialCamera;
        let is3D = true;
        let heightPercent = 50, tiltDegrees = 45;
        let isLeftPanelOpen = false, isRightPanelOpen = false;
        let youbikeStationsCache = null, currentUserPosition = null;
        let userLocationMarker = null;  // æ–°å¢ï¼šä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        let flutterLocationData = null; // å„²å­˜ Flutter å‚³ä¾†çš„ä½ç½®
        let userHasClosedDebugPanel = false; // è¨˜éŒ„ä½¿ç”¨è€…æ˜¯å¦æ‰‹å‹•é—œé–‰äº†é¢æ¿
        let lastLocationUpdateTime = 0; // è¨˜éŒ„ä¸Šæ¬¡ä½ç½®æ›´æ–°æ™‚é–“
        let lastSignificantPosition = null; // è¨˜éŒ„ä¸Šæ¬¡é‡è¦ä½ç½®è®Šæ›´
        const LOCATION_UPDATE_INTERVAL = 35000; // ğŸ”§ å„ªåŒ–ï¼šç¸®çŸ­åˆ°15ç§’
        const SIGNIFICANT_MOVE_DISTANCE = 50; // ğŸ”§ æ–°å¢ï¼š50å…¬å°ºå…§è¦–ç‚ºç„¡é¡¯è‘—ç§»å‹•
        const map2DMarkers = new Map();
        let filterRadiusMeters2D = 2000;
        let markerSizePx2D = 48;
        let showYouBikeMarkers2D = true;
        let hideMapIcons2D = true;
        let infoWindow2D = null;

        const MAP_STYLES_HIDE_ICONS = [
            { elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] }
        ];

        // --- Flutter ä½ç½®æ¥æ”¶å‡½æ•¸ ---
        window.receiveFlutterLocation = function(locationData) {
            console.log('âœ… æ”¶åˆ° Flutter ä½ç½®è³‡æ–™:', locationData);
            
            // ğŸ”§ å„ªåŒ–ï¼šæª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆæ™‚é–“ç¯€æµ + è·é›¢åˆ¤æ–·ï¼‰
            const currentTime = Date.now();
            const timeSinceLastUpdate = currentTime - lastLocationUpdateTime;
            
            // è¨ˆç®—è·é›¢è®ŠåŒ–
            let distanceChanged = Infinity;
            if (lastSignificantPosition) {
                distanceChanged = haversineMeters(
                    lastSignificantPosition.lat, lastSignificantPosition.lng,
                    locationData.lat, locationData.lng
                );
            }
            
            // åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°ï¼šæ™‚é–“é–“éš” OR é¡¯è‘—ç§»å‹•
            const shouldUpdate = timeSinceLastUpdate >= LOCATION_UPDATE_INTERVAL || 
                               distanceChanged >= SIGNIFICANT_MOVE_DISTANCE;
            
            if (!shouldUpdate) {
                console.log(`â±ï¸ è·³éæ›´æ–° - è·é›¢: ${distanceChanged.toFixed(0)}m, æ™‚é–“: ${Math.round(timeSinceLastUpdate/1000)}s`);
                return;
            }
            
            console.log(`ğŸ”„ åŸ·è¡Œä½ç½®æ›´æ–° - è·é›¢è®ŠåŒ–: ${distanceChanged.toFixed(0)}m, æ™‚é–“é–“éš”: ${Math.round(timeSinceLastUpdate/1000)}s`);
            lastLocationUpdateTime = currentTime;
            lastSignificantPosition = { lat: locationData.lat, lng: locationData.lng };
            
            flutterLocationData = locationData;
            
            // æ›´æ–°ç›®å‰ä½ç½®
            currentUserPosition = {
                lat: locationData.lat,
                lng: locationData.lng
            };
            
            // é¡¯ç¤º debug è¨Šæ¯
            const debugDiv = document.getElementById('åµéŒ¯å…§å®¹');
            if (debugDiv) {
                const now = new Date();
                debugDiv.innerHTML = `
                    <strong>Flutter å®šä½è³‡æ–™ (${now.toLocaleTimeString()}):</strong><br>
                    ç·¯åº¦: ${locationData.lat.toFixed(6)}<br>
                    ç¶“åº¦: ${locationData.lng.toFixed(6)}<br>
                    ç²¾ç¢ºåº¦: ${locationData.accuracy.toFixed(1)} å…¬å°º<br>
                    ç§»å‹•è·é›¢: ${distanceChanged.toFixed(0)} å…¬å°º<br>
                    ç‹€æ…‹: âœ… å®šä½æˆåŠŸ<br>
                    <small style="color: #666;">æ™ºèƒ½æ›´æ–° (æ™‚é–“${LOCATION_UPDATE_INTERVAL/1000}s / è·é›¢${SIGNIFICANT_MOVE_DISTANCE}m)</small>
                `;
                document.getElementById('åµéŒ¯è³‡è¨Šå€å¡Š').style.display = 'block';
                document.getElementById('åµéŒ¯æ¨™é¡Œ').textContent = 'å®šä½è³‡è¨Š (é»æ“Šå±•é–‹/æ‘ºç–Š)';
                
                // é¡¯ç¤ºæ‘ºç–ŠæŒ‰éˆ•
                document.getElementById('toggleDebugBtn').style.display = 'block';
                
                // åªåœ¨ 2D æ¨¡å¼ä¸”ä½¿ç”¨è€…æ²’æœ‰æ‰‹å‹•é—œé–‰æ™‚æ‰è‡ªå‹•é¡¯ç¤º
                if (!is3D && !userHasClosedDebugPanel) {
                    document.getElementById('ç›¸æ©Ÿè³‡è¨Š').classList.remove('éš±è—');
                }
            }
            
            // å¦‚æœåœ¨ 2D æ¨¡å¼ï¼Œæ›´æ–°åœ°åœ–æ¨™è¨˜
            if (!is3D && map2D) {
                updateUserLocationMarker(locationData);
            }
        };
        
        // æ›´æ–°ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜
        function updateUserLocationMarker(locationData) {
            if (!map2D) {
                console.log('âŒ map2D ä¸å­˜åœ¨ï¼Œç„¡æ³•å‰µå»ºæ¨™è¨˜');
                return;
            }
            
            console.log('ğŸ“ é–‹å§‹æ›´æ–°ç”¨æˆ¶ä½ç½®æ¨™è¨˜:', locationData);
            
            const position = { lat: locationData.lat, lng: locationData.lng };
            
            // å¦‚æœæ¨™è¨˜å·²å­˜åœ¨ï¼Œæ›´æ–°ä½ç½®
            if (userLocationMarker) {
                console.log('ğŸ”„ æ›´æ–°ç¾æœ‰æ¨™è¨˜ä½ç½®');
                userLocationMarker.setPosition(position);
            } else {
                console.log('ğŸ†• å‰µå»ºæ–°çš„ä½ç½®æ¨™è¨˜');
                
                // å‰µå»ºæ–°çš„æ¨™è¨˜ - ä½¿ç”¨é†’ç›®çš„è—è‰²åœ“é»
                userLocationMarker = new google.maps.Marker({
                    position: position,
                    map: map2D,
                    title: 'æ‚¨çš„ä½ç½®',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15, // å¢å¤§å°ºå¯¸ä»¥æé«˜å¯è¦‹åº¦
                        fillColor: '#4285F4', // Google è—
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 4 // å¢åŠ ç™½è‰²é‚Šæ¡†å¯¬åº¦
                    },
                    zIndex: 999, // ç¢ºä¿åœ¨æœ€ä¸Šå±¤é¡¯ç¤º
                    optimized: false // é˜²æ­¢è¢«å„ªåŒ–éš±è—
                });
                
                // æ·»åŠ è„ˆå‹•æ•ˆæœçš„å¤–åœˆ
                const pulseMarker = new google.maps.Marker({
                    position: position,
                    map: map2D,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 25,
                        fillColor: '#4285F4',
                        fillOpacity: 0.3,
                        strokeColor: '#4285F4',
                        strokeWeight: 1
                    },
                    zIndex: 998
                });
                
                console.log('âœ… ä½ç½®æ¨™è¨˜å·²å‰µå»º:', userLocationMarker);
                
                // æ·»åŠ é»æ“Šäº‹ä»¶é¡¯ç¤ºè¨Šæ¯
                userLocationMarker.addListener('click', () => {
                    console.log('ğŸ” ä½ç½®æ¨™è¨˜è¢«é»æ“Š');
                    const info = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h3>æ‚¨çš„ä½ç½®</h3>
                                <p>ç·¯åº¦: ${locationData.lat.toFixed(6)}</p>
                                <p>ç¶“åº¦: ${locationData.lng.toFixed(6)}</p>
                                <p>ç²¾ç¢ºåº¦: ${locationData.accuracy.toFixed(1)} å…¬å°º</p>
                                <p style="color: #666; font-size: 12px;">è³‡æ–™ä¾†æº: Flutter Geolocator</p>
                            </div>
                        `
                    });
                    info.open(map2D, userLocationMarker);
                });
            }
            
            // ç§»å‹•åœ°åœ–åˆ°ç›®å‰ä½ç½®
            map2D.panTo(position);
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            console.log('ğŸ“ åœ°åœ–å·²ç§»å‹•åˆ°æ‚¨çš„ä½ç½®:', position);
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function haversineMeters(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calculateDistanceAndTime(station) {
            // å–å¾—ç›®å‰ä½ç½®ï¼ˆå„ªå…ˆä½¿ç”¨ Flutter ä½ç½®ï¼Œå…¶æ¬¡æ˜¯åœ°åœ–ä¸­å¿ƒï¼‰
            let currentPos = null;
            
            // å„ªå…ˆä½¿ç”¨ Flutter æä¾›çš„ä½ç½®
            if (flutterLocationData) {
                currentPos = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
            }
            // å¦‚æœæœ‰ç”¨æˆ¶ä½ç½®æ¨™è¨˜ï¼Œä½¿ç”¨è©²ä½ç½®
            else if (userLocationMarker) {
                const pos = userLocationMarker.getPosition();
                if (pos) {
                    currentPos = { lat: pos.lat(), lng: pos.lng() };
                }
            }
            // æœ€å¾Œä½¿ç”¨åœ°åœ–ä¸­å¿ƒä½ç½®
            else if (map2D) {
                const center = map2D.getCenter();
                if (center) {
                    currentPos = { lat: center.lat(), lng: center.lng() };
                }
            }
            
            if (!currentPos) {
                return '<div style="font-size:12px;color:#666;margin-bottom:6px;">ğŸ“ ç„¡æ³•å–å¾—ç›®å‰ä½ç½®</div>';
            }
            
            // è¨ˆç®—ç›´ç·šè·é›¢ï¼ˆå…¬å°ºï¼‰
            const distance = haversineMeters(currentPos.lat, currentPos.lng, station.lat, station.lng);
            
            // æ ¼å¼åŒ–è·é›¢
            let distanceText;
            if (distance < 1000) {
                distanceText = `${Math.round(distance)} å…¬å°º`;
            } else {
                distanceText = `${(distance / 1000).toFixed(1)} å…¬é‡Œ`;
            }
            
            // ä¼°ç®—æ™‚é–“ï¼ˆæ­¥è¡Œé€Ÿåº¦ 5 km/hï¼Œé¨è»Šé€Ÿåº¦ 15 km/hï¼‰
            const walkingTimeMinutes = Math.round((distance / 1000) / 5 * 60);
            const cyclingTimeMinutes = Math.round((distance / 1000) / 15 * 60);
            
            let walkingTimeText, cyclingTimeText;
            
            if (walkingTimeMinutes < 60) {
                walkingTimeText = `${walkingTimeMinutes} åˆ†é˜`;
            } else {
                const hours = Math.floor(walkingTimeMinutes / 60);
                const minutes = walkingTimeMinutes % 60;
                walkingTimeText = `${hours} å°æ™‚ ${minutes} åˆ†é˜`;
            }
            
            if (cyclingTimeMinutes < 60) {
                cyclingTimeText = `${cyclingTimeMinutes} åˆ†é˜`;
            } else {
                const hours = Math.floor(cyclingTimeMinutes / 60);
                const minutes = cyclingTimeMinutes % 60;
                cyclingTimeText = `${hours} å°æ™‚ ${minutes} åˆ†é˜`;
            }
            
            return `
<div style="font-size:12px;color:#666;margin-bottom:6px;padding:4px;background:#f5f5f5;border-radius:4px;">
  <div>ğŸ“ è·é›¢ï¼š${distanceText}</div>
  <div>ğŸš¶ æ­¥è¡Œç´„ï¼š${walkingTimeText}</div>
  <div>ğŸš´ é¨è»Šç´„ï¼š${cyclingTimeText}</div>
</div>`;
        }

        function cleanStationName(rawName) {
            return String(rawName || '').replace(/^YouBike2\.0[_\s-]*/i, '');
        }

        // --- è³‡æ–™æ“·å– ---
        async function loadYouBikeDataNormalized() {
            try {
                const apiUrl = 'https://datacenter.taichung.gov.tw/swagger/OpenData/bc27c2f7-6ed7-4f1a-b3cc-1a3cc9cda34e';
                const resp = await fetch(apiUrl, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const rawData = await resp.json();
                const stations = Array.isArray(rawData.retVal) ? rawData.retVal : (Array.isArray(rawData) ? rawData : []);
                const normalized = stations.map((s, i) => ({
                    id: String(s.sno || i), name: cleanStationName(s.sna), area: String(s.sarea || ''),
                    address: String(s.ar || ''), lat: Number(s.lat), lng: Number(s.lng),
                    totalSlots: Number(s.tot || 0), bikes: Number(s.sbi || 0), docks: Number(s.bemp || 0),
                    isActive: s.act == 1, yb2Bikes: Number(s.sbi_detail?.yb2 || 0),
                    electricBikes: Number(s.sbi_detail?.eyb || 0), lastUpdate: s.mday || ''
                })).filter(s => s.isActive && Number.isFinite(s.lat) && Number.isFinite(s.lng));
                console.info(`[YouBike] æˆåŠŸå¾ API è¼‰å…¥ ${normalized.length} å€‹ç«™é»ã€‚`);
                return normalized;
            } catch (err) {
                console.error('[YouBike] API è¼‰å…¥å¤±æ•—ï¼š', err);
                return [];
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        async function init() {
            try {
                console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                
                // æª¢æŸ¥ Google Maps API æ˜¯å¦å·²è¼‰å…¥
                if (!window.google || !window.google.maps) {
                    console.log('â³ ç­‰å¾… Google Maps API è¼‰å…¥...');
                    // ç­‰å¾… API è¼‰å…¥
                    await new Promise((resolve, reject) => {
                        const checkInterval = setInterval(() => {
                            if (window.google && window.google.maps) {
                                console.log('âœ… Google Maps API å·²è¼‰å…¥');
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                        
                        // 30ç§’è¶…æ™‚
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            reject(new Error('Google Maps API è¼‰å…¥è¶…æ™‚'));
                        }, 30000);
                    });
                }
                
                await show3DMap(); // é è¨­é¡¯ç¤º 3D åœ°åœ–
                setupEventListeners();
                
                console.log('âœ… æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
                const container = document.getElementById('åœ°åœ–å®¹å™¨');
                container.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #f5f5f5;">
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                            <h3 style="color: #d32f2f; margin-bottom: 10px;">âŒ åœ°åœ–è¼‰å…¥å¤±æ•—</h3>
                            <p style="color: #666; margin-bottom: 15px;">Google Maps API ç„¡æ³•è¼‰å…¥</p>
                            <button onclick="location.reload()" style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                ğŸ”„ é‡æ–°è¼‰å…¥
                            </button>
                            <div style="margin-top: 15px; font-size: 12px; color: #999;">
                                éŒ¯èª¤è©³æƒ…: ${error.message}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ğŸ”§ å„ªåŒ–ï¼šä½¿ç”¨äº‹ä»¶é©…å‹•æ›¿ä»£å®šæ™‚æª¢æŸ¥
            if (typeof window !== 'undefined') {
                // ä¸å†ä½¿ç”¨ setIntervalï¼Œæ”¹ç‚ºäº‹ä»¶é©…å‹•æ¨¡å¼
                console.log('âœ… è¨­å®šäº‹ä»¶é©…å‹•ä½ç½®æ›´æ–°æ¨¡å¼');
                
                // å¦‚æœéœ€è¦ Web å¹³å°æ”¯æ´ï¼Œå¯ä»¥ç›£è½ storage äº‹ä»¶
                window.addEventListener('storage', (e) => {
                    if (e.key === 'flutterLocation' && e.newValue) {
                        try {
                            const data = JSON.parse(e.newValue);
                            if (data && data.lat && data.lng && !is3D && map2D) {
                                currentUserPosition = { lat: data.lat, lng: data.lng };
                                updateUserLocationMarker(data);
                                localStorage.removeItem('flutterLocation'); // æ¸…é™¤é¿å…é‡è¤‡
                            }
                        } catch (error) {
                            console.warn('ä½ç½®è³‡æ–™è§£æå¤±æ•—:', error);
                        }
                    }
                });
            }
        }

        function setupEventListeners() {
            // å®šä½è³‡è¨Šé¢æ¿åˆ‡æ›
            document.getElementById('toggleDebugBtn').onclick = () => {
                const panel = document.getElementById('ç›¸æ©Ÿè³‡è¨Š');
                const wasHidden = panel.classList.contains('éš±è—');
                panel.classList.toggle('éš±è—');
                const btn = document.getElementById('toggleDebugBtn');
                btn.textContent = panel.classList.contains('éš±è—') ? 'ğŸ“' : 'âŒ';
                
                // è¨˜éŒ„ä½¿ç”¨è€…çš„é¸æ“‡
                if (wasHidden) {
                    // ä½¿ç”¨è€…ä¸»å‹•é–‹å•Ÿ
                    userHasClosedDebugPanel = false;
                } else {
                    // ä½¿ç”¨è€…ä¸»å‹•é—œé–‰
                    userHasClosedDebugPanel = true;
                }
            };
            
            document.getElementById('leftPanelToggle').onclick = () => togglePanel('left');
            document.getElementById('rightPanelToggle').onclick = () => togglePanel('right');
            document.getElementById('mapToggleBtn').onclick = async () => {
                is3D = !is3D;
                if (is3D) await show3DMap(); else await show2DMap();
            };
            
            // æ¨™é¡Œé»æ“Šé‡ç½®åŠŸèƒ½
            const titleElement = document.getElementById('æ¨™é¡Œ');
            titleElement.style.cursor = 'pointer';
            titleElement.title = 'é»æ“Šå›åˆ°æœ€åˆè¦–è§’';
            titleElement.onclick = () => {
                if (is3D) {
                    resetToInitial();
                }
            };
            
            // é»æ“Šé¢æ¿å¤–éƒ¨æ™‚ï¼Œé—œé–‰é¢æ¿
            document.getElementById('åœ°åœ–å®¹å™¨').addEventListener('click', () => {
                if(isLeftPanelOpen) togglePanel('left', false);
                if(isRightPanelOpen) togglePanel('right', false);
            });
        }

        async function show3DMap() {
            const { Map3DElement, MapMode, Marker3DInteractiveElement } = await google.maps.importLibrary("maps3d");
            const container = document.getElementById('åœ°åœ–å®¹å™¨');
            container.innerHTML = '';
            map3D = new Map3DElement({ center: { lat: 24.147736, lng: 120.673648, altitude: 2000 }, range: 30000, tilt: 30, mode: MapMode.HYBRID });
            container.append(map3D);

            if (!initialCamera) {
                initialCamera = {
                    center: {
                        lat: 24.147736,
                        lng: 120.673648,
                        altitude: 2000
                    },
                    range: 30000,
                    tilt: 30,
                    heading: 0
                };
            }
            
            taichungSpots.forEach(spot => {
                const marker = new Marker3DInteractiveElement({ position: spot.pos, label: spot.name, altitudeMode: "ABSOLUTE", extruded: true });
                marker.addEventListener("gmp-click", () => flyToAndRotate(spot));
                map3D.append(marker);
            });

            build3DControlPanel();
            build3DSpotPanel();
            
            // åˆå§‹æ™‚éš±è— 3D é¢æ¿
            document.getElementById('å·¦å´é¢æ¿').classList.add('é¢æ¿éš±è—');
            document.getElementById('å³å´æ§åˆ¶').classList.add('é¢æ¿éš±è—');
            // æ›´æ–°æŒ‰éˆ•åœ–ç¤ºç‚ºé—œé–‰ç‹€æ…‹
            document.getElementById('leftPanelToggle').textContent = 'ğŸ—ºï¸';
            document.getElementById('rightPanelToggle').textContent = 'âš™ï¸';
            
            // æ¸…ç† 2D åœ°åœ–çš„æ¨™è¨˜
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
                userLocationMarker = null;
            }
            
            // é—œé–‰ 2D çš„ YouBike é¢æ¿
            document.getElementById('youbikePanel2D').style.display = 'none';
            document.getElementById('youbikePanel2D').classList.add('youbikeé¢æ¿éš±è—');
            
            // é¡¯ç¤ºæ¨™é¡Œ
            document.getElementById('æ¨™é¡Œ').style.display = 'block';
            
            // 3D æ¨¡å¼æ™‚éš±è—å®šä½è³‡è¨Šé¢æ¿
            document.getElementById('ç›¸æ©Ÿè³‡è¨Š').classList.add('éš±è—');
            
            updateButtonVisibility();
        }

        async function show2DMap() {
            await google.maps.importLibrary('maps');
            const container = document.getElementById('åœ°åœ–å®¹å™¨');
            container.innerHTML = '';
            map2D = new google.maps.Map(container, { 
                center: { lat: 24.147736, lng: 120.673648 }, 
                zoom: 13, 
                mapTypeId: 'roadmap',
                // ç¦ç”¨é»˜è®¤æ§ä»¶
                zoomControl: false,           // ç¦ç”¨ç¼©æ”¾æŒ‰é’®
                mapTypeControl: false,        // ç¦ç”¨åœ°å›¾ç±»å‹åˆ‡æ¢
                scaleControl: false,          // ç¦ç”¨æ¯”ä¾‹å°º
                streetViewControl: false,     // ç¦ç”¨è¡—æ™¯æ§ä»¶ï¼ˆé»„è‰²äººå‹å›¾æ ‡ï¼‰
                rotateControl: false,         // ç¦ç”¨æ—‹è½¬æ§ä»¶
                fullscreenControl: false,     // ç¦ç”¨å…¨å±æ§ä»¶
                gestureHandling: 'greedy'     // ä¼˜åŒ–è§¦æ‘¸æ‰‹åŠ¿
            });
            infoWindow2D = new google.maps.InfoWindow();

            if (hideMapIcons2D) map2D.setOptions({ styles: MAP_STYLES_HIDE_ICONS });

            // åœ¨ 2D æ¨¡å¼ä¸‹ï¼Œéš±è— 3D çš„é¢æ¿
            document.getElementById('å·¦å´é¢æ¿').classList.add('é¢æ¿éš±è—');
            document.getElementById('å³å´æ§åˆ¶').classList.add('é¢æ¿éš±è—');
            // éš±è—æ¨™é¡Œ
            document.getElementById('æ¨™é¡Œ').style.display = 'none';
            
            // 2D æ¨¡å¼æ™‚ï¼Œé‡ç½®ä½¿ç”¨è€…é—œé–‰ç‹€æ…‹ï¼ˆè®“é¢æ¿å¯ä»¥è‡ªå‹•é¡¯ç¤ºä¸€æ¬¡ï¼‰
            // ä½†å¦‚æœä½¿ç”¨è€…å·²ç¶“ä¸»å‹•é—œé–‰ï¼Œå°±ä¿æŒé—œé–‰
            if (!userHasClosedDebugPanel && flutterLocationData) {
                document.getElementById('ç›¸æ©Ÿè³‡è¨Š').classList.remove('éš±è—');
            }

            buildYouBike2DPanel();
            setupLocationButton(); // åˆå§‹åŒ–å®šä½æŒ‰é’®
            updateButtonVisibility();

            // å„ªå…ˆä½¿ç”¨ Flutter ä½ç½®ï¼Œå¦å‰‡ä½¿ç”¨ç€è¦½å™¨å®šä½
            const useCenterAndRender = async (center) => {
                map2D.setCenter(center);
                map2D.setZoom(16);  // æ”¾å¤§åˆ°æ›´è©³ç´°çš„ç´šåˆ¥
                if (!youbikeStationsCache) youbikeStationsCache = await loadYouBikeDataNormalized();
                render2DYouBikeMarkers(center);
            };
            
            // å¦‚æœå·²æœ‰ Flutter ä½ç½®è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨
            if (flutterLocationData) {
                console.log('ä½¿ç”¨ Flutter ä½ç½®è³‡æ–™');
                currentUserPosition = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
                updateUserLocationMarker(flutterLocationData);
                useCenterAndRender(currentUserPosition);
            } else if (navigator.geolocation) {
                // Web å¹³å°ï¼šä½¿ç”¨ç€è¦½å™¨å®šä½ API
                navigator.geolocation.getCurrentPosition(
                    (pos) => { 
                        console.log('ç€è¦½å™¨å®šä½æˆåŠŸ:', pos.coords);
                        currentUserPosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        
                        // å‰µå»ºè—è‰²å®šä½æ¨™è¨˜
                        const locationData = {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude,
                            accuracy: pos.coords.accuracy
                        };
                        updateUserLocationMarker(locationData);
                        useCenterAndRender(currentUserPosition);
                    },
                    (error) => {
                        console.log('ç€è¦½å™¨å®šä½å¤±æ•—:', error);
                        useCenterAndRender({ lat: 24.147736, lng: 120.673648 });
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                );
            } else {
                useCenterAndRender({ lat: 24.147736, lng: 120.673648 });
            }

            map2D.addListener('idle', () => render2DYouBikeMarkers(map2D.getCenter().toJSON()));
        }

        function updateButtonVisibility() {
            document.getElementById('leftPanelToggle').style.display = is3D ? 'block' : 'none';
            document.getElementById('rightPanelToggle').style.display = is3D ? 'block' : 'none';
            document.getElementById('youbikeToggleBtn').style.display = is3D ? 'none' : 'block';
            document.getElementById('locationBtn').style.display = is3D ? 'none' : 'block'; // å®šä½æŒ‰é’®åªåœ¨2Dæ¨¡å¼æ˜¾ç¤º
            document.getElementById('mapToggleBtn').textContent = is3D ? 'ğŸ§Š' : 'ğŸ—ºï¸';
        }

        // --- 3D åŠŸèƒ½ ---
        function flyToAndRotate(spot) {
            const closeupCamera = { center: spot.pos, range: Math.max(spot.camera.range * 0.45, 600) * (heightPercent / 100), tilt: tiltDegrees, heading: map3D.heading };
            map3D.flyCameraTo({ endCamera: closeupCamera, durationMillis: 2000 });
            map3D.addEventListener('gmp-animationend', () => map3D.flyCameraAround({ camera: closeupCamera, durationMillis: 4000, rounds: 1 }), { once: true });
        }

        function resetToInitial() {
            console.log('é‡ç½®è¦–è§’è¢«é»æ“Š');
            if (!map3D) {
                console.log('map3D ä¸å­˜åœ¨');
                return;
            }
            heightPercent = 50;  // é‡ç½®ç‚ºé è¨­å€¼
            tiltDegrees = 30;    // é‡ç½®ç‚ºé è¨­å€¼
            
            const resetCamera = {
                center: {
                    lat: 24.147736,
                    lng: 120.673648,
                    altitude: 2000
                },
                range: 30000,
                tilt: 30,
                heading: 0
            };
            
            console.log('æ­£åœ¨é‡ç½®åˆ°åˆå§‹è¦–è§’', resetCamera);
            map3D.flyCameraTo({ endCamera: resetCamera, durationMillis: 1200 });
            build3DControlPanel(); // é‡å»ºä»¥æ›´æ–°æ»‘æ¡¿é¡¯ç¤º
        }

        function build3DSpotPanel() {
            const panel = document.getElementById('å·¦å´é¢æ¿');
            panel.innerHTML = '';
            taichungSpots.forEach(spot => {
                const btn = document.createElement('button');
                btn.className = 'æ™¯é»æŒ‰éˆ•';
                btn.textContent = spot.name;
                btn.onclick = () => {
                    // é»æ“Šæ™¯é»æ™‚ï¼ŒåŸ·è¡Œé£›è¡Œä¸¦é—œé–‰é¢æ¿
                    flyToAndRotate(spot);
                    if (isLeftPanelOpen) {
                        togglePanel('left', false);
                    }
                };
                panel.appendChild(btn);
            });
        }

        function build3DControlPanel() {
            const controls = document.getElementById('å³å´æ§åˆ¶');
            controls.innerHTML = '';
            const title = document.createElement('div');
            title.style.cssText = 'font-weight:bold; font-family:Arial,sans-serif;';
            title.textContent = 'è¦–è§’æ§åˆ¶';
            controls.appendChild(title);

            [
                { label: 'ä»°è§’', value: tiltDegrees, min: 20, max: 90, step: 5, oninput: (v) => {
                    tiltDegrees = v;
                    if (map3D) {
                        const currentCamera = {
                            center: map3D.center,
                            range: map3D.range,
                            tilt: tiltDegrees,
                            heading: map3D.heading
                        };
                        map3D.flyCameraTo({ endCamera: currentCamera, durationMillis: 300 });
                    }
                }},
                { label: 'é«˜åº¦', value: heightPercent, min: 20, max: 120, step: 10, oninput: (v) => {
                    heightPercent = v;
                    if (map3D) {
                        const currentCamera = {
                            center: map3D.center,
                            range: map3D.range * (heightPercent / 100),
                            tilt: map3D.tilt,
                            heading: map3D.heading
                        };
                        map3D.flyCameraTo({ endCamera: currentCamera, durationMillis: 300 });
                    }
                }}
            ].forEach(item => {
                const group = document.createElement('div');
                group.className = 'control-group';
                const labelEl = document.createElement('label');
                labelEl.textContent = `${item.label}ï¼š${item.value}${item.label === 'ä»°è§’' ? 'Â°' : '%'}`;
                const inputEl = document.createElement('input');
                Object.assign(inputEl, { type: 'range', min: item.min, max: item.max, step: item.step, value: item.value });
                inputEl.oninput = () => {
                    item.oninput(parseInt(inputEl.value, 10));
                    labelEl.textContent = `${item.label}ï¼š${inputEl.value}${item.label === 'ä»°è§’' ? 'Â°' : '%'}`;
                };
                group.append(labelEl, inputEl);
                controls.appendChild(group);
            });

            const resetBtn = document.createElement('button');
            resetBtn.className = 'æ™¯é»æŒ‰éˆ•';
            resetBtn.textContent = 'é‡ç½®è¦–è§’';
            resetBtn.onclick = resetToInitial;
            controls.appendChild(resetBtn);
        }

        function togglePanel(side, forceState) {
            const isOpen = side === 'left' ? isLeftPanelOpen : isRightPanelOpen;
            const newState = forceState === undefined ? !isOpen : forceState;
            const panel = document.getElementById(side === 'left' ? 'å·¦å´é¢æ¿' : 'å³å´æ§åˆ¶');
            const toggleBtn = document.getElementById(side === 'left' ? 'leftPanelToggle' : 'rightPanelToggle');
            
            panel.classList.toggle('é¢æ¿éš±è—', !newState);
            
            if (side === 'left') {
                isLeftPanelOpen = newState;
                toggleBtn.textContent = newState ? 'â¬…ï¸' : 'ğŸ—ºï¸'; // æ ¹æ“šç‹€æ…‹æ”¹è®Šåœ–ç¤º
            } else {
                isRightPanelOpen = newState;
                toggleBtn.textContent = newState ? 'â¡ï¸' : 'âš™ï¸'; // æ ¹æ“šç‹€æ…‹æ”¹è®Šåœ–ç¤º
            }
        }

        function toggleLeftPanel() {
            togglePanel('left');
        }

        function toggleRightPanel() {
            togglePanel('right');
        }

        // --- 2D åŠŸèƒ½ ---
        function setupLocationButton() {
            const locationBtn = document.getElementById('locationBtn');
            if (!locationBtn) return;
            
            locationBtn.onclick = () => {
                // å„ªå…ˆä½¿ç”¨ Flutter ä½ç½®
                if (flutterLocationData) {
                    console.log('ä½¿ç”¨ Flutter ä½ç½®ç§»å‹•åœ°åœ–');
                    const pos = { lat: flutterLocationData.lat, lng: flutterLocationData.lng };
                    map2D.setCenter(pos);
                    map2D.setZoom(16);
                    
                    // ç¢ºä¿ç”¨æˆ¶ä½ç½®æ¨™è¨˜å­˜åœ¨ä¸¦æ›´æ–°
                    if (userLocationMarker) {
                        userLocationMarker.setPosition(pos);
                    } else {
                        updateUserLocationMarker(flutterLocationData);
                    }
                    return;
                }
                
                // ä½¿ç”¨ç€è¦½å™¨å®šä½ API
                if (navigator.geolocation) {
                    locationBtn.style.opacity = '0.6'; // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map2D.setCenter(pos);
                            map2D.setZoom(16);
                            
                            // å‰µå»ºæˆ–æ›´æ–°ä½ç½®æ¨™è¨˜
                            const locationData = {
                                lat: pos.lat,
                                lng: pos.lng,
                                accuracy: position.coords.accuracy
                            };
                            updateUserLocationMarker(locationData);
                            
                            locationBtn.style.opacity = '1'; // æ¢å¾©æ­£å¸¸ç‹€æ…‹
                            console.log('âœ… ç€è¦½å™¨å®šä½æˆåŠŸï¼Œå·²ç§»å‹•åˆ°ç›®å‰ä½ç½®');
                        },
                        (error) => {
                            locationBtn.style.opacity = '1'; // æ¢å¾©æ­£å¸¸ç‹€æ…‹
                            console.error('å®šä½å¤±æ•—:', error);
                            alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªå·²å…è¨±ä½ç½®å­˜å–æ¬Šé™');
                        },
                        { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 300000 
                        }
                    );
                } else {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                }
            };
        }

        function buildYouBike2DPanel() {
            const panel = document.getElementById('youbikePanel2D');
            panel.innerHTML = '';
            panel.style.display = 'flex';

            let isPanelVisible = true;
            document.getElementById('youbikeToggleBtn').onclick = () => {
                isPanelVisible = !isPanelVisible;
                panel.classList.toggle('youbikeé¢æ¿éš±è—', !isPanelVisible);
            };

            const title = document.createElement('div');
            title.style.cssText = 'font-weight:bold; font-family:Arial,sans-serif;';
            title.textContent = 'YouBike 2.0 å–®è»Šç«™é»';
            panel.appendChild(title);

            [
                { label: 'é¡¯ç¤ºå–®è»Šåœ–æ¨™', type: 'checkbox', checked: showYouBikeMarkers2D, onchange: (c) => { showYouBikeMarkers2D = c; render2DYouBikeMarkers(map2D.getCenter().toJSON()); } },
                { label: 'éš±è—åœ°ååœ–æ¨™', type: 'checkbox', checked: hideMapIcons2D, onchange: (c) => { hideMapIcons2D = c; map2D.setOptions({ styles: c ? MAP_STYLES_HIDE_ICONS : null }); } },
                { label: `æœå°‹åŠå¾‘ï¼š${filterRadiusMeters2D}m`, type: 'range', min: 500, max: 5000, value: filterRadiusMeters2D, oninput: (v, el) => { filterRadiusMeters2D = v; el.textContent = `æœå°‹åŠå¾‘ï¼š${v}m`; }, onchange: () => render2DYouBikeMarkers(map2D.getCenter().toJSON()) },
                { label: `æ¨™è¨˜å¤§å°ï¼š${markerSizePx2D}px`, type: 'range', min: 28, max: 72, value: markerSizePx2D, oninput: (v, el) => { markerSizePx2D = v; el.textContent = `æ¨™è¨˜å¤§å°ï¼š${v}px`; }, onchange: () => render2DYouBikeMarkers(map2D.getCenter().toJSON()) }
            ].forEach(item => {
                const group = document.createElement('div');
                group.className = 'control-group';
                const labelEl = document.createElement('label');
                labelEl.textContent = item.label;
                const inputEl = document.createElement('input');
                Object.assign(inputEl, { type: item.type, min: item.min, max: item.max, value: item.value, checked: item.checked });
                inputEl.oninput = () => item.oninput?.(inputEl.type === 'checkbox' ? inputEl.checked : parseInt(inputEl.value, 10), labelEl);
                inputEl.onchange = () => item.onchange?.(inputEl.type === 'checkbox' ? inputEl.checked : parseInt(inputEl.value, 10));
                group.append(labelEl, inputEl);
                panel.appendChild(group);
            });
        }

        // ğŸ”§ å„ªåŒ–ï¼šå¢åŠ æ¸²æŸ“ç¯€æµå’Œé‡è¤‡æª¢æŸ¥
        let lastRenderCenter = null;
        let isRendering = false;
        let renderRequestId = null;
        const MIN_RENDER_DISTANCE = 100; // åœ°åœ–ä¸­å¿ƒç§»å‹•100å…¬å°ºä»¥ä¸Šæ‰é‡æ–°æ¸²æŸ“

        function render2DYouBikeMarkers(center) {
            if (!Array.isArray(youbikeStationsCache) || !map2D) return;
            if (!showYouBikeMarkers2D) { clear2DMarkers(); return; }

            // ğŸ”§ å„ªåŒ–ï¼šæª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
            if (lastRenderCenter) {
                const moveDistance = haversineMeters(
                    lastRenderCenter.lat, lastRenderCenter.lng,
                    center.lat, center.lng
                );
                if (moveDistance < MIN_RENDER_DISTANCE) {
                    console.log(`â±ï¸ è·³é YouBike æ¸²æŸ“ - ç§»å‹•è·é›¢: ${moveDistance.toFixed(0)}m < ${MIN_RENDER_DISTANCE}m`);
                    return;
                }
            }

            // ğŸ”§ å„ªåŒ–ï¼šé˜²æ­¢é‡è¤‡æ¸²æŸ“
            if (isRendering) {
                console.log('â±ï¸ YouBike æ¸²æŸ“é€²è¡Œä¸­ï¼Œè·³éæ­¤æ¬¡è«‹æ±‚');
                return;
            }

            // ğŸ”§ å„ªåŒ–ï¼šå–æ¶ˆä¹‹å‰çš„æ¸²æŸ“è«‹æ±‚
            if (renderRequestId) {
                cancelAnimationFrame(renderRequestId);
            }

            // ğŸ”§ å„ªåŒ–ï¼šä½¿ç”¨ requestAnimationFrame æå‡æ€§èƒ½
            renderRequestId = requestAnimationFrame(() => {
                performYouBikeRender(center);
            });
        }

        function performYouBikeRender(center) {
            isRendering = true;
            console.log(`ğŸ”„ YouBike æ¸²æŸ“é–‹å§‹ - ä¸­å¿ƒ: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);

            const startTime = performance.now();
            const within = youbikeStationsCache.filter(st => 
                haversineMeters(center.lat, center.lng, st.lat, st.lng) <= filterRadiusMeters2D
            );

            const toDelete = new Set(map2DMarkers.keys());
            let updatedCount = 0;
            let createdCount = 0;

            within.forEach(st => {
                const icon = buildBikeIcon(statusColorForStation(st), markerSizePx2D);
                if (map2DMarkers.has(st.id)) {
                    const mk = map2DMarkers.get(st.id);
                    mk.setIcon(icon);
                    mk.setPosition({ lat: st.lat, lng: st.lng });
                    updatedCount++;
                } else {
                    const mk = new google.maps.Marker({ 
                        position: { lat: st.lat, lng: st.lng }, 
                        map: map2D, 
                        title: `${st.name}ï½œå€Ÿ:${st.bikes} é‚„:${st.docks}`, 
                        icon 
                    });
                    mk.addListener('click', () => {
                        const { statusSymbol, statusText } = getStationStatus(st);
                        
                        // ä½¿ç”¨æ–°çš„è·é›¢å’Œæ™‚é–“è¨ˆç®—å‡½æ•¸
                        const distanceInfo = calculateDistanceAndTime(st);
                        
                        infoWindow2D.setContent(`<div style="font-family:Arial, sans-serif; min-width: 240px;">
                          <div style="font-size:14px;color:#666;margin-bottom:4px;">ç«™è™Ÿ: ${st.id}</div>
                          <div style="font-weight:700;font-size:18px;margin-bottom:8px;color:#111;">${st.name}</div>
                          <div style="font-size:14px;margin-bottom:8px;color:#333;">ç‹€æ…‹: ${statusSymbol} ${statusText}</div>
                          ${distanceInfo}
                          <div style="font-size:14px;line-height:1.5;">
                            <div>ğŸš² å¯å€Ÿè»Šè¼›ï¼š${st.bikes}</div>
                            <div>ğŸ…¿ï¸ å¯é‚„è»Šä½ï¼š${st.docks}</div>
                            <div>ğŸ“Š ç¸½è»Šä½æ•¸ï¼š${st.totalSlots}</div>
                            <div>âš¡ é›»å‹•è»Šï¼š${st.electricBikes}</div>
                          </div>
                        </div>`);
                        infoWindow2D.open({ map: map2D, anchor: mk, shouldFocus: false });
                    });
                    map2DMarkers.set(st.id, mk);
                    createdCount++;
                }
                toDelete.delete(st.id);
            });

            // æ‰¹é‡åˆªé™¤è¶…å‡ºç¯„åœçš„æ¨™è¨˜
            let deletedCount = 0;
            for (const id of toDelete) {
                map2DMarkers.get(id)?.setMap(null);
                map2DMarkers.delete(id);
                deletedCount++;
            }

            const endTime = performance.now();
            const renderTime = endTime - startTime;
            
            console.log(`âœ… YouBike æ¸²æŸ“å®Œæˆ - ç”¨æ™‚: ${renderTime.toFixed(1)}ms, å‰µå»º: ${createdCount}, æ›´æ–°: ${updatedCount}, åˆªé™¤: ${deletedCount}, ç¸½æ•¸: ${within.length}`);
            
            lastRenderCenter = { lat: center.lat, lng: center.lng };
            isRendering = false;
            renderRequestId = null;
        }

        function clear2DMarkers() {
            for (const mk of map2DMarkers.values()) mk.setMap(null);
            map2DMarkers.clear();
        }

        function getStationStatus(st) {
            if (!st.isActive) return { statusSymbol: 'ğŸ”´', statusText: 'ç¶­è­·ä¸­' };
            if (st.bikes === 0) return { statusSymbol: 'ğŸŸ¡', statusText: 'ç„¡è»Šå¯å€Ÿ' };
            if (st.docks === 0) return { statusSymbol: 'ğŸŸ¡', statusText: 'ç„¡ä½å¯é‚„' };
            if (st.bikes <= 2 || st.docks <= 2) return { statusSymbol: 'ğŸŸ ', statusText: 'è»Šä½ä¸è¶³' };
            return { statusSymbol: 'ğŸŸ¢', statusText: 'æ­£å¸¸é‹ä½œ' };
        }

        function statusColorForStation(st) {
            const status = getStationStatus(st).statusSymbol;
            if (status === 'ğŸ”´') return '#d93025';
            if (status === 'ğŸŸ¡') return '#fbbc04';
            if (status === 'ğŸŸ ') return '#f29900';
            return '#34a853';
        }

        function buildBikeIcon(color, sizePx) {
            const s = Math.max(28, Math.min(72, sizePx)); // FIX: Corrected the min/max values to match the slider
            const stroke = '#0f172a';
            const halo = '#ffffff';
            const body = color; // ä¸»è‰²ä¾ç‹€æ…‹
            const seat = '#111827';
            const frame = '#1f2937';
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns='http://www.w3.org/2000/svg' width='${s}' height='${s}' viewBox='0 0 32 32'>
  <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
    <feDropShadow dx="1" dy="1" stdDeviation="1.5" flood-color="#000000" flood-opacity="0.4"/>
  </filter>
  <!-- å¤–åœˆç™½æšˆ -->
  <g fill='${halo}' stroke='${halo}' stroke-width='4' opacity='0.9' filter="url(#shadow)">
    <circle cx='9' cy='22' r='7'/>
    <circle cx='23' cy='22' r='7'/>
  </g>
  <!-- è»Šè¼ªèˆ‡è¼ªæ¡† -->
  <g fill='${body}' stroke='${stroke}' stroke-width='1.8' filter="url(#shadow)">
    <circle cx='9' cy='22' r='6'/>
    <circle cx='23' cy='22' r='6'/>
  </g>
  <!-- è»Šæ¶ -->
  <g fill='none' stroke='${frame}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' filter="url(#shadow)">
    <path d='M9 22l6-10h6l6 10' />
    <path d='M15 12l3 7M12 16h6' />
  </g>
  <!-- è»Šåº§èˆ‡æŠŠæ‰‹ -->
  <g fill='${seat}' stroke='${stroke}' stroke-width='1.2' filter="url(#shadow)">
    <rect x='14.5' y='9' width='4' height='1.6' rx='0.6' />
  </g>
  <!-- å‰ç‡ˆï¼ˆæå‡è¾¨è­˜åº¦ï¼‰ -->
  <circle cx='28.5' cy='14' r='1.6' fill='#fde68a' stroke='${stroke}' stroke-width='0.8' filter="url(#shadow)"/>
</svg>`;
            const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
            return {
                url,
                scaledSize: new google.maps.Size(s, s),
                anchor: new google.maps.Point(s/2, s/2)
            };
        }

        // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
            init();
        }
    </script>
</body>

</html>